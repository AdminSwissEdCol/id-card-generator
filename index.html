<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student ID Card Generator â€” SEC</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 820px;
    margin: 0 auto;
    padding: 28px 18px 60px;
    background: #f0f2f5;
    color: #222;
    line-height: 1.6;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header { margin-bottom: 28px; }
.header h1 { font-size: 22px; margin-bottom: 4px; }
.header p  { font-size: 14px; color: #666; }

/* â”€â”€ Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section {
    background: #fff;
    border-radius: 10px;
    padding: 22px;
    margin-bottom: 16px;
    border: 1px solid #e0e3e8;
    border-top: 5px solid #d1d5db;   /* default = gray */
    transition: border-top-color 0.2s, opacity 0.2s;
}
.section.active     { border-top-color: #4c7cff; }   /* blue  = action needed */
.section.configured { border-top-color: #34a853; }   /* green = complete */
.section.done       { border-top-color: #34a853; }   /* green = complete */
.section.locked     { border-top-color: #d1d5db; opacity: 0.4; pointer-events: none; user-select: none; }

/* â”€â”€ Section header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-head {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
    flex-wrap: wrap;
}
.section-head h2 { font-size: 16px; flex: 1; min-width: 0; }

.step-badge {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    padding: 3px 9px;
    border-radius: 20px;
    white-space: nowrap;
    flex-shrink: 0;
}
.badge-gray  { background: #f0f0f0; color: #888; }
.badge-blue  { background: #e8f0fe; color: #1967d2; }
.badge-green { background: #e6f4ea; color: #137333; }
.badge-warn  { background: #fef7e0; color: #b06000; }

/* done checkmark badge */
.done-badge {
    font-size: 11px;
    font-weight: 700;
    color: #137333;
    background: #e6f4ea;
    padding: 3px 9px;
    border-radius: 20px;
    display: none;
    flex-shrink: 0;
}
.section.done .done-badge { display: inline; }

/* â”€â”€ ? help button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.help-btn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 22px; height: 22px;
    background: #eef0f4; border: 1px solid #d0d3d8;
    border-radius: 50%; font-size: 12px; font-weight: 700;
    color: #555; cursor: pointer; flex-shrink: 0;
    transition: background 0.15s, color 0.15s;
    line-height: 1;
    padding: 0;
}
.help-btn:hover { background: #dde2ef; color: #1a3a7a; }
.help-btn.active { background: #4c7cff; color: white; border-color: #4c7cff; }

/* â”€â”€ Help panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.help {
    display: none;
    background: #f8f9fc;
    border: 1px solid #e0e3e8;
    border-radius: 8px;
    padding: 13px 16px;
    font-size: 13px;
    color: #555;
    margin-top: 14px;
    line-height: 1.7;
}
.help.open { display: block; }
.help strong { color: #333; }
.help a { color: #4c7cff; text-decoration: none; }
.help a:hover { text-decoration: underline; }

.help-toggle {
    background: none; border: none; color: #4c7cff;
    font-size: 12px; cursor: pointer; padding: 0;
    margin-top: 8px; display: block; text-align: left;
}
.help-extra { display: none; margin-top: 10px; border-top: 1px solid #e0e0e0; padding-top: 10px; }
.help-extra.open { display: block; }

/* â”€â”€ Action box (blue = "do this now") â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.action-box {
    background: #e8f0fe;
    border-left: 4px solid #4c7cff;
    padding: 12px 15px;
    border-radius: 0 6px 6px 0;
    margin-bottom: 16px;
    font-size: 14px;
    color: #1a3a7a;
    font-weight: 500;
}

/* â”€â”€ Input fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
label.field { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 5px; }
label.field small { font-weight: 400; color: #888; }

input[type="url"], input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    border: 1.5px solid #d6d6d6;
    border-radius: 6px;
    font-size: 13px;
    font-family: monospace;
    margin-bottom: 12px;
    transition: border-color 0.15s;
}
input:focus { outline: none; border-color: #4c7cff; }
input.set   { border-color: #34a853; background: #f8fff9; }
.input-row  { display: flex; gap: 10px; }
.input-row input { margin-bottom: 0; }

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn {
    display: inline-block; border: none; border-radius: 6px;
    font-size: 14px; font-weight: 600; cursor: pointer;
    padding: 10px 20px; transition: filter 0.15s;
    text-decoration: none; white-space: nowrap;
}
.btn:hover:not(:disabled) { filter: brightness(0.9); }
.btn:disabled { opacity: 0.45; cursor: not-allowed; }
.btn-blue   { background: #4c7cff; color: white; }
.btn-green  { background: #34a853; color: white; font-size: 15px; padding: 11px 28px; }
.btn-yellow { background: #fbbc04; color: #333; }
.btn-link   { background: #f0f2f5; color: #444; border: 1px solid #d0d3d8; font-size: 13px; padding: 7px 14px; }

/* â”€â”€ Status messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status {
    font-size: 13px; margin-top: 12px;
    padding: 10px 14px;
    border-radius: 6px;
    border-left: 4px solid transparent;
    display: none;
    font-weight: 500;
}
.status.show    { display: block; }
.status.success { background: #e6f4ea; color: #137333; border-left-color: #34a853; }
.status.error   { background: #fce8e6; color: #c5221f; border-left-color: #ea4335; }
.status.info    { background: #e8f0fe; color: #1967d2; border-left-color: #4c7cff; }
.status.warning { background: #fef7e0; color: #b06000; border-left-color: #fbbc04; }

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
th { padding: 9px 10px; border-bottom: 2px solid #e6e6e6; text-align: left; font-weight: 600; color: #444; background: #f9f9f9; }
td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
tr:last-child td { border-bottom: none; }

.cbadge { background: #e8f0fe; color: #1967d2; padding: 2px 9px; border-radius: 10px; font-size: 12px; font-family: monospace; font-weight: 500; }
.val-inp { padding: 7px 9px; border: 1.5px solid #d6d6d6; border-radius: 5px; font-size: 13px; width: 175px; font-family: monospace; }
.val-inp:focus { outline: none; border-color: #4c7cff; }
.val-inp.ok   { border-color: #34a853; background: #f8fff9; }
.val-inp.skip { border-color: #ea4335; color: #bbb; }

/* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prog-wrap  { margin-top: 14px; }
.prog-bar   { height: 8px; background: #e6e6e6; border-radius: 4px; overflow: hidden; }
.prog-fill  { height: 100%; background: #4c7cff; width: 0%; transition: width 0.5s ease; border-radius: 4px; }
.prog-label { font-size: 12px; color: #888; margin-top: 5px; }

/* â”€â”€ Result / Download card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.folder-card {
    background: #f0faf4;
    border: 1px solid #b7e0c4;
    border-top: 4px solid #34a853;
    border-radius: 10px;
    padding: 20px;
    margin-top: 14px;
}
.folder-card h4 {
    font-size: 15px;
    color: #137333;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.folder-tree {
    background: white;
    border: 1px solid #dde5dd;
    border-radius: 6px;
    padding: 12px 14px;
    font-family: monospace;
    font-size: 12px;
    line-height: 2;
    margin-bottom: 18px;
    color: #333;
}
.folder-tree a { color: #1967d2; text-decoration: none; }
.folder-tree a:hover { text-decoration: underline; }

/* Download steps redesign */
.dl-steps { display: flex; flex-direction: column; gap: 10px; }
.dl-step {
    display: flex;
    gap: 14px;
    align-items: flex-start;
    background: white;
    border: 1px solid #d6e8d6;
    border-radius: 8px;
    padding: 14px 16px;
}
.dl-num {
    flex-shrink: 0;
    width: 28px; height: 28px;
    background: #34a853; color: white;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700;
    margin-top: 1px;
}
.dl-body { flex: 1; font-size: 13px; line-height: 1.6; }
.dl-body strong { color: #222; }
.dl-body .dl-sub {
    margin-top: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.dl-body .dl-sub span {
    display: flex;
    align-items: baseline;
    gap: 6px;
    color: #444;
}
.dl-body .dl-sub span::before {
    content: 'â†’';
    color: #34a853;
    font-weight: 700;
    flex-shrink: 0;
}

.err-log { max-height: 120px; overflow-y: auto; background: #fce8e6; border-radius: 5px; padding: 9px; margin: 14px 0 0; font-size: 12px; color: #c5221f; }

/* â”€â”€ Misc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
code { background: #eee; padding: 1px 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }
pre  { background: #f5f5f5; padding: 11px; border-radius: 6px; font-size: 12px; line-height: 1.8; margin: 8px 0; overflow-x: auto; }

.chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.chip  { background: #f1f3f4; padding: 3px 10px; border-radius: 10px; font-size: 12px; }
.chip.red { background: #fce8e6; color: #c5221f; }

/* Settings collapsed body */
.settings-body { display: block; }
.settings-body.collapsed { display: none; }
/* Remove gap below header when body is hidden */
#settingsSection .settings-body.collapsed ~ * { display: none; }
.section.configured .section-head { margin-bottom: 0; }

/* How It Works â€” collapsible */
.howit-toggle {
    width: 100%; background: none; border: none; text-align: left;
    font-size: 14px; font-weight: 600; color: #444; cursor: pointer;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0; gap: 8px;
}
.howit-toggle .arrow { font-size: 12px; color: #999; transition: transform 0.2s; }
.howit-toggle.open .arrow { transform: rotate(180deg); }
.howit-body { display: none; margin-top: 14px; }
.howit-body.open { display: block; }

.footer { text-align: center; margin-top: 40px; font-size: 12px; color: #aaa; }

@media (max-width: 560px) { .input-row { flex-direction: column; } }
</style>
</head>
<body>

<div class="header">
    <h1>Student ID Card Generator</h1>
    <p>SEC &mdash; Generate student list and photos automatically</p>
</div>

<!-- â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="section active" id="settingsSection">
    <div class="section-head">
        <h2>One-Time Setup</h2>
        <span class="step-badge badge-blue" id="settingsBadge" style="display:none;">Unsaved changes</span>
        <span id="savedOk" class="step-badge badge-green" style="display:none;">âœ“ Saved</span>
        <span class="done-badge">âœ“ Configured</span>
        <button class="btn btn-link" id="changeSettingsBtn" onclick="openSettings()" style="display:none;font-size:12px;padding:4px 12px;">Change Settings</button>
        <button class="help-btn" id="settingsHelpBtn" onclick="toggleHelp(this)" title="Show help" style="display:none;">?</button>
    </div>

    <div class="settings-body" id="settingsBody">
    <div class="action-box">
        Enter both URLs once and click <strong>Save Settings</strong> â€” remembered in your browser for future visits.
    </div>

    <label class="field" for="inWebApp">Apps Script Web App URL (IDMakerTool)
        <small>&mdash; the backend that reads your sheets and copies photos</small>
    </label>
    <input type="url" id="inWebApp" placeholder="https://script.google.com/macros/s/AKfycb/exec" oninput="onSettingsChange()" />

    <label class="field" for="inSheet1">Student Pictures Directory URL (Sheet1)
        <small>&mdash; Col B = Email, Col C = Drive photo link</small>
    </label>
    <input type="url" id="inSheet1" placeholder="https://docs.google.com/spreadsheets/d/..." oninput="onSettingsChange()" />

    <button class="btn btn-yellow" onclick="saveSettings()">Save Settings</button>

    <div class="help">
        <strong>How to get the Apps Script URL:</strong> open any Google Sheet (IDMakerTool) &rarr; Extensions &rarr; Apps Script &rarr;
        paste <code>StudentIDCards.gs</code> &rarr; Save &rarr; Deploy &rarr; New deployment &rarr; Web app &rarr;
        Execute as: Me, Who has access: Anyone &rarr; Deploy &rarr; copy URL &rarr; paste above.<br><br>
        After any script change always re-deploy as a <strong>New version</strong> or the old code keeps running.<br><br>
        <strong>Settings work in incognito but not normal browser?</strong>
        Hard-reload with <strong>Ctrl+Shift+R</strong> (Win) or <strong>Cmd+Shift+R</strong> (Mac).
        <button class="help-toggle" onclick="toggleHelpExtra(this)">More about Sheet1 and troubleshooting</button>
        <div class="help-extra">
            Sheet1 is in the <strong>Metabase_Foto</strong> Google Drive folder:<br>
            Col A = Name (ignored) &middot; Col B = School email &middot; Col C = Drive thumbnail URL<br><br>
            <strong>Settings not saving?</strong> localStorage does not persist in incognito windows.
            Use a regular browser window. Clearing browser data also removes saved settings.
        </div>
    </div>
    </div><!-- /.settings-body -->
</div>

<!-- â”€â”€ STEP 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="section active" id="step1">
    <div class="section-head">
        <span class="step-badge badge-blue">Step 1 of 3</span>
        <h2>Load Student Data</h2>
        <span class="done-badge">âœ“ Done</span>
        <button class="help-btn" onclick="toggleHelp(this)" title="Show help">?</button>
    </div>

    <div class="action-box">
        Paste your master class list URL and click <strong>Load Classes</strong>.
    </div>

    <div class="input-row">
        <input type="url" id="inSheet2" placeholder="https://docs.google.com/spreadsheets/d/..." onkeydown="if(event.key==='Enter') loadClasses()" />
        <button class="btn btn-blue" id="btnLoad" onclick="loadClasses()">Load Classes</button>
    </div>
    <div class="status" id="st1"></div>

    <div class="help">
        <strong>Required column headers in Sheet2:</strong>
        <code>Class</code> &middot; <code>First Name Last Name</code> &middot; <code>School Email</code> &middot; <code>Birthday</code><br>
        Only rows where Class matches the format <code>YY-TX-Class-Level</code> are included.
        All other rows are ignored automatically.
        <button class="help-toggle" onclick="toggleHelpExtra(this)">Troubleshooting</button>
        <div class="help-extra">
            <strong>Button does nothing:</strong> Apps Script URL not saved &mdash; check Settings above.<br>
            <strong>Network error:</strong> re-deploy the Apps Script as a New version using latest <code>StudentIDCards.gs</code> (v6).<br>
            <strong>Cannot open Sheet2:</strong> the Apps Script owner needs Viewer access &mdash; open Sheet2, Share, add their email.<br>
            <strong>Class column not found:</strong> row 1 must have a header cell with exactly <code>Class</code>.<br>
            <strong>0 students loaded:</strong> no rows matched <code>YY-TX-Class-*</code> format &mdash; check the Class column values.
        </div>
    </div>
</div>

<!-- â”€â”€ STEP 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="section locked" id="step2">
    <div class="section-head">
        <span class="step-badge badge-gray" id="step2badge">Step 2 of 3</span>
        <h2>Set Validity Periods</h2>
        <span class="done-badge">âœ“ Done</span>
        <button class="help-btn" onclick="toggleHelp(this)" title="Show help">?</button>
    </div>

    <div class="action-box" id="step2action">
        Complete Step 1 first &mdash; class groups will appear here automatically.
    </div>

    <div id="step2content" style="display:none;">
        <table>
            <thead><tr>
                <th>Class Group</th>
                <th>Students</th>
                <th>Validity Period</th>
                <th></th>
            </tr></thead>
            <tbody id="classBody"></tbody>
        </table>
        <div class="status" id="st2"></div>
        <div class="chips" id="classChips"></div>
    </div>

    <div class="help">
        Format: <code>MM/YYYY-MM/YYYY</code> &mdash; e.g. <code>10/2025-09/2026</code><br>
        Leave a row blank to skip that class group. Values are pre-filled automatically.
        <button class="help-toggle" onclick="toggleHelpExtra(this)">Default validity periods by intake term</button>
        <div class="help-extra">
            <code>25-T3-Class-</code> &rarr; <code>07/2025-06/2026</code><br>
            <code>25-T4-Class-</code> &rarr; <code>10/2025-09/2026</code><br>
            <code>26-T1-Class-</code> &rarr; <code>01/2026-12/2026</code><br>
            <code>26-T2-Class-</code> &rarr; <code>04/2026-03/2027</code><br><br>
            To add new terms permanently, edit <code>DEFAULT_VALIDITY</code> at the top of <code>index.html</code>.
        </div>
    </div>
</div>

<!-- â”€â”€ STEP 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="section locked" id="step3">
    <div class="section-head">
        <span class="step-badge badge-gray" id="step3badge">Step 3 of 3</span>
        <h2>Generate Files</h2>
        <span class="done-badge">âœ“ Done</span>
        <button class="help-btn" onclick="toggleHelp(this)" title="Show help">?</button>
    </div>

    <div class="action-box" id="step3action">
        Complete Steps 1 &amp; 2 first &mdash; generate buttons will appear here automatically.
    </div>

    <div id="chunkBtns" style="display:none;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
            <!-- buttons injected here -->
        </div>
        <a href="https://drive.google.com/drive/folders/1pNhZyZQRzgqFNYniaaZ47Vf1FYeZ_G5S?usp=drive_link"
           target="_blank" class="btn btn-link" style="margin-top:4px;">Open IDMakerTool Folder</a>
    </div>

    <div id="progWrap" style="display:none;" class="prog-wrap">
        <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
        <div class="prog-label" id="progLbl"></div>
    </div>

    <div class="status" id="st3"></div>
    <div id="result"></div>

    <div class="help">
        Each button processes up to 50 students (~2.5 min). All photos go into
        the same <strong>ID_Files_[date]</strong> folder in Drive. The Excel sheet
        is written automatically after the last chunk completes.
        <button class="help-toggle" onclick="toggleHelpExtra(this)">Error messages and troubleshooting</button>
        <div class="help-extra">
            <strong>Failed to fetch:</strong> re-deploy Apps Script as a New version using latest <code>StudentIDCards.gs</code> (v8). Execute as: Me, Who has access: Anyone.<br>
            <strong>0 students matched:</strong> no validity periods set in Step 2 &mdash; fill in at least one row.<br>
            <strong>Many missing photos:</strong> those students are in Sheet2 but not Sheet1 &mdash; add their email and Drive photo URL to Sheet1 and re-run.<br>
            <strong>A chunk timed out:</strong> click that chunk button again to retry &mdash; already-completed chunks are not re-run.
        </div>
    </div>
</div>

<!-- â”€â”€ HOW IT WORKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="section">
    <button class="howit-toggle" id="howitToggle" onclick="toggleHowIt()">
        <span>How It Works</span>
        <span class="arrow">â–¼</span>
    </button>
    <div class="howit-body" id="howitBody">
        <div class="help" style="display:block;margin-top:0;">
            <strong>Sheet1</strong> (Student Pictures Directory) &mdash; maps each student email to their Drive photo. Col B = email, Col C = thumbnail URL.<br>
            <strong>Sheet2</strong> (Class List) &mdash; master student list. Only <code>YY-TX-Class-*</code> rows are processed.<br>
            <strong>Apps Script</strong> &mdash; Google-hosted backend. No local installation needed.<br><br>

            <strong>Output folder structure (auto-created in Drive):</strong>
            <pre>My Drive/
  â””â”€â”€ Metabase_Foto/
        â””â”€â”€ IDMakerTool/
              â””â”€â”€ ID_Files_20260224_1430/
                    â”œâ”€â”€ ID_Cards_Output     â† open â†’ File â†’ Download â†’ Excel (.xlsx)
                    â””â”€â”€ Photos/             â† already named correctly, download and unzip</pre>

            <strong>Name cleaning examples:</strong><br>
            <code>-Ann- Thi Dung Phung</code> &rarr; <code>Thi Dung Phung</code><br>
            <code>Phan -Annabelle- Thi Bich Ngan</code> &rarr; <code>Phan Thi Bich Ngan</code>
        </div>
    </div>
</div>

<div class="footer">SEC &middot; Student ID Card Generator v6</div>

<script>
var DEFAULT_VALIDITY = {
    '25-T3-': '07/2025-06/2026',
    '25-T4-': '10/2025-09/2026',
    '26-T1-': '01/2026-12/2026',
    '26-T2-': '04/2026-03/2027',
    '26-T3-': '07/2026-06/2027',
    '26-T4-': '10/2026-09/2027'
};

var WEB_APP_URL = '';
var SHEET1_URL  = '';
var VALID_CLASS_RE = /^\d{2}-T[1-4]-Class-/;

window.onload = function() {
    WEB_APP_URL = localStorage.getItem('idcard_webapp') || '';
    SHEET1_URL  = localStorage.getItem('idcard_sheet1') || '';
    document.getElementById('inWebApp').value = WEB_APP_URL;
    document.getElementById('inSheet1').value = SHEET1_URL;
    if (WEB_APP_URL) document.getElementById('inWebApp').classList.add('set');
    if (SHEET1_URL)  document.getElementById('inSheet1').classList.add('set');
    updateSettingsBorder();
};

function saveSettings() {
    WEB_APP_URL = document.getElementById('inWebApp').value.trim();
    SHEET1_URL  = document.getElementById('inSheet1').value.trim();
    localStorage.setItem('idcard_webapp', WEB_APP_URL);
    localStorage.setItem('idcard_sheet1', SHEET1_URL);
    document.getElementById('inWebApp').classList.toggle('set', !!WEB_APP_URL);
    document.getElementById('inSheet1').classList.toggle('set', !!SHEET1_URL);
    document.getElementById('settingsBadge').style.display = 'none';
    // Close any open help panel
    var helpPanel = document.querySelector('#settingsSection .help');
    if (helpPanel) { helpPanel.classList.remove('open'); }
    var helpBtn = document.getElementById('settingsHelpBtn');
    if (helpBtn) helpBtn.classList.remove('active');
    updateSettingsBorder();
    var ok = document.getElementById('savedOk');
    ok.style.display = 'inline';
    setTimeout(function(){ ok.style.display = 'none'; }, 2500);
}

function onSettingsChange() {
    document.getElementById('savedOk').style.display = 'none';
    document.getElementById('settingsBadge').style.display = 'inline';
}

function updateSettingsBorder() {
    var done = !!(WEB_APP_URL && SHEET1_URL);
    var sec  = document.getElementById('settingsSection');
    sec.classList.toggle('configured', done);
    sec.classList.toggle('active', !done);

    // Collapse body when configured, expand when not
    document.getElementById('settingsBody').classList.toggle('collapsed', done);
    document.getElementById('changeSettingsBtn').style.display = done ? 'inline-block' : 'none';
    document.getElementById('settingsHelpBtn').style.display   = done ? 'none' : 'inline-flex';
}

function openSettings() {
    var body = document.getElementById('settingsBody');
    body.classList.remove('collapsed');
    document.getElementById('changeSettingsBtn').style.display = 'none';
    document.getElementById('settingsHelpBtn').style.display   = 'inline-flex';
}

function toggleHelp(btn) {
    var section = btn.closest('.section');
    var panel   = section.querySelector('.help');
    if (!panel) return;
    var isOpen  = panel.classList.toggle('open');
    btn.classList.toggle('active', isOpen);
    btn.title = isOpen ? 'Hide help' : 'Show help';
}

function toggleHelpExtra(btn) {
    var extra = btn.nextElementSibling;
    var open  = extra.classList.toggle('open');
    btn.textContent = (open ? 'Hide' : 'Show') + btn.textContent.replace(/^(Hide|Show)\s*/,'');
}

function toggleHowIt() {
    var btn  = document.getElementById('howitToggle');
    var body = document.getElementById('howitBody');
    btn.classList.toggle('open');
    body.classList.toggle('open');
}

// â”€â”€ Step state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CHUNK_SIZE    = 50;
var totalStudents = 0;

var genState = {
    runFolderId:    null,
    photosFolderId: null,
    spreadsheetId:  null,
    runFolderUrl:   null,
    runFolderName:  null,
    totalOk:        0,
    allErrors:      [],
    chunksTotal:    0,
    chunksDone:     0
};

function unlockStep(id) {
    var el = document.getElementById(id);
    el.classList.remove('locked');
    el.classList.add('active');
    // Update badge color
    var badge = el.querySelector('.step-badge');
    if (badge) { badge.className = 'step-badge badge-blue'; }
}

function markDone(id) {
    var el = document.getElementById(id);
    el.classList.remove('locked', 'active');
    el.classList.add('done');
    var badge = el.querySelector('.step-badge');
    if (badge) { badge.className = 'step-badge badge-green'; }
}

// â”€â”€ Step 1: Load classes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadClasses() {
    var s2 = document.getElementById('inSheet2').value.trim();
    var wa = document.getElementById('inWebApp').value.trim() || WEB_APP_URL;

    if (!wa) {
        showBar('st1','error','Apps Script URL not saved. Fill in the Settings section above and click Save Settings.');
        return;
    }
    WEB_APP_URL = wa;
    if (!s2) { showBar('st1','error','Please paste the Sheet2 URL.'); return; }
    if (s2.indexOf('docs.google.com/spreadsheets') === -1) {
        showBar('st1','error','That does not look like a Google Sheets URL.'); return;
    }

    showBar('st1','info','Connecting to Apps Script and reading Sheet2...');
    document.getElementById('btnLoad').disabled = true;

    callScript({ action: 'loadClasses', sheet2Url: s2 })
        .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Unknown error');
            if (!data.classes.length) throw new Error('No valid class groups found. Check that the Class column in Sheet2 has values matching YY-TX-Class-Level format.');
            totalStudents = data.totalStudents;
            buildClassTable(data.classes, data.totalStudents);
            showBar('st1','success','âœ“ Loaded ' + data.totalStudents + ' students across ' + data.classes.length + ' class group(s).');
            markDone('step1');
            unlockStep('step2');
            unlockStep('step3');
            buildChunkButtons(data.totalStudents);
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(function(e) {
            showBar('st1','error', 'âœ— ' + e.message + ' â€” click ? above for troubleshooting.');
        })
        .finally(function() { document.getElementById('btnLoad').disabled = false; });
}

// â”€â”€ Step 3: Build chunk buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChunkButtons(total) {
    var numChunks = Math.ceil(total / CHUNK_SIZE);
    genState.chunksTotal = numChunks;
    genState.chunksDone  = 0;

    var wrap = document.getElementById('chunkBtns');
    var btnRow = wrap.querySelector('div');
    btnRow.innerHTML = '';

    for (var i = 0; i < numChunks; i++) {
        var start = i * CHUNK_SIZE + 1;
        var end   = Math.min((i + 1) * CHUNK_SIZE, total);
        var btn   = document.createElement('button');
        btn.id        = 'chunk_btn_' + i;
        btn.className = 'btn ' + (i === 0 ? 'btn-green' : 'btn-link');
        btn.style.minWidth = '130px';
        btn.textContent = (numChunks === 1)
            ? 'Generate All (' + total + ')'
            : 'Generate ' + start + 'â€“' + end;
        btn.disabled  = (i !== 0);
        btn.onclick   = (function(chunkIdx) { return function() { runChunk(chunkIdx); }; })(i);
        btnRow.appendChild(btn);
    }

    document.getElementById('step3action').innerHTML =
        numChunks === 1
        ? 'Click <strong>Generate All</strong> to process all ' + total + ' students (~2.5 min). Do not close this tab.'
        : 'Click each chunk button in order. Each chunk takes ~2.5 min. Do not close this tab between chunks.';

    wrap.style.display = 'block';
}

// â”€â”€ Run one chunk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runChunk(chunkIdx) {
    var s1 = document.getElementById('inSheet1').value.trim() || SHEET1_URL;
    var s2 = document.getElementById('inSheet2').value.trim();

    if (!WEB_APP_URL) { showBar('st3','error','âœ— Apps Script URL not set â€” fill in Settings.'); return; }
    if (!s1)          { showBar('st3','error','âœ— Photo Index URL not set â€” fill in Settings.'); return; }
    if (!s2)          { showBar('st3','error','âœ— Sheet2 URL missing â€” complete Step 1.'); return; }

    var validityMap = {};
    document.querySelectorAll('.val-inp').forEach(function(inp) {
        var p = inp.getAttribute('data-prefix'), v = inp.value.trim();
        if (p && v) validityMap[p] = v;
    });
    if (!Object.keys(validityMap).length) {
        showBar('st3','error','âœ— No validity periods configured â€” fill in at least one row in Step 2.'); return;
    }

    for (var i = 0; i < genState.chunksTotal; i++) {
        var b = document.getElementById('chunk_btn_' + i);
        if (b) b.disabled = true;
    }

    var chunkStart = chunkIdx * CHUNK_SIZE;
    var label = genState.chunksTotal === 1
        ? 'Processing all students...'
        : 'Processing chunk ' + (chunkIdx + 1) + ' of ' + genState.chunksTotal + '...';

    document.getElementById('progWrap').style.display = 'block';
    setProgress(10 + (chunkIdx / genState.chunksTotal) * 80, label);
    showBar('st3','info', label + ' Do not close this tab.');

    var payload = {
        action:         'generate',
        sheet1Url:      s1,
        sheet2Url:      s2,
        validityMap:    validityMap,
        chunkStart:     chunkStart,
        chunkSize:      CHUNK_SIZE,
        runFolderId:    genState.runFolderId,
        photosFolderId: genState.photosFolderId,
        spreadsheetId:  genState.spreadsheetId
    };

    callScript(payload)
        .then(function(res) {
            if (!res.success) throw new Error(res.error || 'Chunk failed');

            genState.runFolderId    = res.runFolderId;
            genState.photosFolderId = res.photosFolderId;
            genState.spreadsheetId  = res.spreadsheetId;
            genState.runFolderUrl   = res.runFolderUrl;
            genState.runFolderName  = res.runFolderName;
            genState.totalOk       += res.photoOk;
            genState.allErrors      = genState.allErrors.concat(res.photoErrors || []);
            genState.chunksDone++;

            var doneBtn = document.getElementById('chunk_btn_' + chunkIdx);
            if (doneBtn) {
                doneBtn.textContent = 'âœ“ ' + doneBtn.textContent.replace(/^âœ“\s*/,'');
                doneBtn.className = 'btn btn-link';
                doneBtn.style.opacity = '0.6';
                doneBtn.disabled = true;
            }

            if (res.isLast) {
                setProgress(100, 'Complete!');
                showBar('st3','success',
                    'âœ“ ' + res.totalStudents + ' students â€” ' + genState.totalOk + ' photos copied' +
                    (genState.allErrors.length ? ', ' + genState.allErrors.length + ' missing.' : '.'));
                renderResult(res.spreadsheetUrl);
                markDone('step3');
                document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
            } else {
                var nextBtn = document.getElementById('chunk_btn_' + (chunkIdx + 1));
                if (nextBtn) {
                    nextBtn.disabled  = false;
                    nextBtn.className = 'btn btn-green';
                }
                var pct = (genState.chunksDone / genState.chunksTotal) * 100;
                setProgress(pct, 'Chunk ' + genState.chunksDone + ' of ' + genState.chunksTotal + ' done â€” click next chunk to continue.');
                showBar('st3','success',
                    'âœ“ Chunk ' + genState.chunksDone + '/' + genState.chunksTotal + ' done â€” ' +
                    genState.totalOk + ' photos so far. Click the next button to continue.');
            }
        })
        .catch(function(e) {
            var failBtn = document.getElementById('chunk_btn_' + chunkIdx);
            if (failBtn) { failBtn.disabled = false; failBtn.className = 'btn btn-green'; }
            showBar('st3','error', 'âœ— Chunk ' + (chunkIdx + 1) + ' failed: ' + e.message + ' â€” you can click the button again to retry.');
        });
}

function renderResult(spreadsheetUrl) {
    var errs = genState.allErrors;
    var errBlock = errs.length
        ? '<div class="err-log"><strong>âš  Missing photos (' + errs.length + ') â€” add to Sheet1 and re-run:</strong><br>' +
          errs.map(function(e){ return '&bull; ' + esc(e); }).join('<br>') + '</div>'
        : '';

    document.getElementById('result').innerHTML =
        '<div class="folder-card">' +
            '<h4>ğŸ“‚ Files ready in Google Drive â€” ' + genState.totalOk + ' photos</h4>' +
            '<div class="folder-tree">' +
                'ğŸ“ <a href="' + esc(genState.runFolderUrl) + '" target="_blank"><strong>' + esc(genState.runFolderName) + '</strong></a><br>' +
                '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ“Š <a href="' + esc(spreadsheetUrl) + '" target="_blank">ID_Cards_Output</a>' +
                ' <span style="color:#888;font-size:11px;">(Google Sheet)</span><br>' +
                '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ“ Photos/' +
                ' <span style="color:#888;font-size:11px;">(' + genState.totalOk + ' photos, already named correctly)</span>' +
            '</div>' +
            errBlock +
            '<div class="dl-steps">' +

                '<div class="dl-step">' +
                    '<div class="dl-num">1</div>' +
                    '<div class="dl-body">' +
                        '<a href="' + esc(genState.runFolderUrl) + '" target="_blank" class="btn btn-green" style="font-size:14px;padding:10px 22px;">Open Drive Folder &rarr;</a>' +
                    '</div>' +
                '</div>' +

                '<div class="dl-step">' +
                    '<div class="dl-num">2</div>' +
                    '<div class="dl-body">' +
                        '<strong>Download both files:</strong>' +
                        '<div class="dl-sub">' +
                            '<span>Open <strong>ID_Cards_Output</strong> &rarr; File &rarr; Download &rarr; <strong>Excel (.xlsx)</strong> &rarr; save to a local folder</span>' +
                            '<span>Right-click <strong>Photos/</strong> &rarr; Download &rarr; <strong>unzip</strong> it (folder is already named <code>Photos</code>)</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +

                '<div class="dl-step">' +
                    '<div class="dl-num">3</div>' +
                    '<div class="dl-body">' +
                        'Place the <code>Photos</code> folder <strong>next to</strong> the <code>.xlsx</code> file &rarr; ' +
                        'open Excel &rarr; click any cell in <strong>Link_to_Cropped_Photo</strong> &rarr; photo opens locally' +
                    '</div>' +
                '</div>' +

            '</div>' +
        '</div>';
}

function buildClassTable(classes, total) {
    document.getElementById('step2action').textContent = 'Review and confirm the validity period for each class group. Leave blank to skip a group.';
    document.getElementById('step2content').style.display = 'block';
    var tbody = document.getElementById('classBody');
    tbody.innerHTML = '';
    var inc = 0, skip = 0;
    classes.forEach(function(c) {
        var def = guessValidity(c.prefix);
        if (def) inc += c.count; else skip += c.count;
        var sid = 'v_' + c.prefix.replace(/[^a-z0-9]/gi, '_');
        var tr  = document.createElement('tr');
        tr.innerHTML =
            '<td><span class="cbadge">' + esc(c.prefix) + '</span></td>' +
            '<td style="color:#666;">' + c.count + '</td>' +
            '<td>' +
                '<input class="val-inp ' + (def ? 'ok' : 'skip') + '" id="' + sid + '"' +
                ' data-prefix="' + esc(c.prefix) + '" value="' + esc(def) + '"' +
                ' placeholder="MM/YYYY-MM/YYYY" oninput="onValChange(this)">' +
                (!def ? ' <span style="font-size:11px;color:#ea4335;margin-left:4px;">will be skipped</span>' : '') +
            '</td>' +
            '<td style="font-size:16px;">' + (def ? 'âœ…' : 'âš ï¸') + '</td>';
        tbody.appendChild(tr);
    });
    if (skip > 0) showBar('st2','warning', 'âš  ' + skip + ' student(s) in unrecognised class groups.');
    else          showBar('st2','success', 'âœ“ All ' + total + ' students have a validity period assigned.');
    document.getElementById('classChips').innerHTML =
        '<div class="chip">Total: ' + total + '</div>' +
        '<div class="chip" style="background:#e6f4ea;color:#137333;">Included: ' + inc + '</div>' +
        (skip ? '<div class="chip red">Skipped: ' + skip + '</div>' : '');
}

function onValChange(inp) {
    var v = inp.value.trim();
    inp.classList.toggle('ok', !!v); inp.classList.toggle('skip', !v);
    var icon = inp.closest('tr').cells[3];
    if (icon) icon.textContent = v ? 'âœ…' : 'âš ï¸';
}

function guessValidity(prefix) {
    if (!VALID_CLASS_RE.test(prefix)) return '';
    for (var k in DEFAULT_VALIDITY) {
        if (DEFAULT_VALIDITY.hasOwnProperty(k) && prefix.indexOf(k) === 0)
            return DEFAULT_VALIDITY[k];
    }
    return '';
}

function callScript(payload) {
    var base = WEB_APP_URL || document.getElementById('inWebApp').value.trim();
    if (!base) return Promise.reject(new Error('Apps Script URL not configured.'));
    var url = base + '?payload=' + encodeURIComponent(JSON.stringify(payload));
    return fetch(url, { method: 'GET', redirect: 'follow' })
        .catch(function(err) {
            throw new Error('Cannot reach Apps Script. Check the URL in Settings is correct and the script is deployed as a Web App with Anyone access. Detail: ' + err.message);
        })
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status + ' from Apps Script. Re-deploy as a new version.');
            return r.text();
        })
        .then(function(text) {
            try { return JSON.parse(text); }
            catch(e) { throw new Error('Apps Script returned unexpected content. Re-deploy using latest StudentIDCards.gs. Preview: ' + text.substring(0, 200)); }
        });
}

function showBar(id, type, msg) {
    var el = document.getElementById(id);
    el.className   = 'status show ' + type;
    el.textContent = msg;
}
function setProgress(pct, lbl) {
    document.getElementById('progFill').style.width = pct + '%';
    document.getElementById('progLbl').textContent  = lbl;
}
function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
