<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student ID Card Generator â€” Swiss Educational College</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px; margin: 0 auto; padding: 20px;
    background: #f0f2f5; line-height: 1.6; color: #333;
}

/* â”€â”€ Header â”€â”€ */
.header {
    text-align: center; margin-bottom: 24px;
    padding-bottom: 20px; border-bottom: 3px solid #c8102e;
}
.header h1 { color: #c8102e; font-size: 1.8em; margin-bottom: 4px; }
.header p  { color: #666; font-size: 1em; }

/* â”€â”€ Settings panel â”€â”€ */
.settings-panel {
    border-radius: 10px; margin-bottom: 18px; overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #ffc107; background: #fffde7;
}
.settings-panel.ok { border-color: #34a853; background: white; }

.settings-toggle {
    width: 100%; display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; background: transparent; border: none;
    cursor: pointer; font-size: 14px; font-weight: 600; color: #333; text-align: left;
}
.settings-toggle:hover { background: rgba(0,0,0,0.03); }

.s-badge {
    display: inline-block; font-size: 11px; font-weight: 600;
    padding: 2px 9px; border-radius: 10px; margin-left: 8px;
}
.s-badge.warn { background: #fce8e6; color: #c5221f; }
.s-badge.good { background: #e6f4ea; color: #137333; }
.s-arrow { font-size: 12px; color: #888; }

.settings-body { padding: 0 18px 18px; }
.settings-body.hidden { display: none; }

/* â”€â”€ Field labels & inputs â”€â”€ */
.field-label {
    display: block; font-size: 13px; font-weight: 600;
    margin: 14px 0 5px; color: #333;
}
.field-label small { font-weight: 400; color: #888; }
.url-input {
    width: 100%; padding: 10px 13px;
    border: 2px solid #ddd; border-radius: 6px;
    font-size: 13px; font-family: monospace;
}
.url-input:focus { outline: none; border-color: #4285f4; }
.url-input.set { border-color: #34a853; background: #f8fff9; }

/* â”€â”€ Steps â”€â”€ */
.step {
    background: white; border-radius: 10px; padding: 20px 22px;
    margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 5px solid #ddd;
}
.step.active   { border-left-color: #4285f4; }
.step.done     { border-left-color: #34a853; background: #f9fff9; }
.step.locked   { border-left-color: #ddd; background: #fafafa; }
.step.errored  { border-left-color: #ea4335; }

.step-hdr { display: flex; align-items: center; margin-bottom: 14px; }
.step-num {
    min-width: 34px; height: 34px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; margin-right: 12px;
    background: #ddd; color: #888;
}
.step.active .step-num  { background: #4285f4; color: white; }
.step.done   .step-num  { background: #34a853; color: white; }
.step.done   .step-num::after { content: "âœ“"; }
.step.done   .step-num .num   { display: none; }
.step-title { font-size: 1.05em; font-weight: 600; }
.step-sub   { font-size: 12px; color: #999; margin-left: 5px; }

/* Locked overlay message */
.locked-msg {
    text-align: center; padding: 20px; color: #aaa; font-size: 14px;
}

/* â”€â”€ Buttons â”€â”€ */
.btn {
    display: inline-block; padding: 10px 20px;
    border-radius: 6px; border: none; cursor: pointer;
    font-size: 14px; font-weight: 600; margin: 4px 4px 4px 0;
    text-decoration: none; transition: filter 0.15s;
}
.btn:hover:not(:disabled) { filter: brightness(0.92); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-blue   { background: #4285f4; color: white; }
.btn-green  { background: #34a853; color: white; }
.btn-yellow { background: #fbbc04; color: #333; }
.btn-lg     { font-size: 16px; padding: 14px 36px; }

/* â”€â”€ Input rows â”€â”€ */
.input-row { display: flex; gap: 10px; margin: 8px 0; }
.input-row input {
    flex: 1; padding: 10px 13px;
    border: 2px solid #ddd; border-radius: 6px; font-size: 14px;
}
.input-row input:focus { outline: none; border-color: #4285f4; }

/* â”€â”€ Status bars â”€â”€ */
.status-bar {
    margin: 10px 0; padding: 10px 14px;
    border-radius: 6px; font-size: 13px;
}
.status-bar.hidden  { display: none; }
.status-bar.info    { background: #e8f0fe; color: #1967d2; }
.status-bar.success { background: #e6f4ea; color: #137333; }
.status-bar.error   { background: #fce8e6; color: #c5221f; }
.status-bar.warning { background: #fef7e0; color: #b06000; }

/* â”€â”€ Callout boxes â”€â”€ */
.callout {
    border-left: 4px solid #ffc107; background: #fff8e1;
    padding: 10px 14px; border-radius: 0 6px 6px 0;
    margin: 10px 0; font-size: 13px; color: #555;
}
.callout.blue  { border-color: #4285f4; background: #e8f0fe; color: #1967d2; }
.callout.green { border-color: #34a853; background: #e6f4ea; color: #137333; }
.callout.red   { border-color: #ea4335; background: #fce8e6; color: #c5221f; }

/* â”€â”€ Class validity table â”€â”€ */
.vtable { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
.vtable th {
    background: #f1f3f4; padding: 9px 11px; text-align: left;
    font-weight: 600; color: #444; border-bottom: 2px solid #e0e0e0;
}
.vtable td { padding: 8px 11px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
.vtable tr:last-child td { border-bottom: none; }
.cbadge {
    display: inline-block; background: #e8f0fe; color: #1967d2;
    padding: 2px 10px; border-radius: 12px; font-size: 12px;
    font-weight: 500; font-family: monospace;
}
.val-inp {
    padding: 7px 9px; border: 1.5px solid #ddd; border-radius: 5px;
    font-size: 13px; width: 180px; font-family: monospace;
}
.val-inp:focus { outline: none; border-color: #4285f4; }
.val-inp.ok   { border-color: #34a853; background: #f8fff9; }
.val-inp.skip { border-color: #ea4335; color: #bbb; }

/* â”€â”€ Progress â”€â”€ */
.prog-wrap { margin: 10px 0; }
.prog-bar  { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
.prog-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, #4285f4, #34a853);
    width: 0%; transition: width 0.5s ease;
}
.prog-label { font-size: 12px; color: #666; margin-top: 4px; }

/* â”€â”€ Result box â”€â”€ */
.result-box {
    border-radius: 10px; padding: 22px; color: white;
    text-align: center; margin-top: 12px;
    background: linear-gradient(135deg, #34a853, #1a7a37);
}
.result-box.warn { background: linear-gradient(135deg, #f9a825, #e65100); }
.result-box h3   { font-size: 1.3em; margin-bottom: 8px; }
.result-stats    { display: flex; justify-content: center; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
.result-stat     { background: rgba(255,255,255,0.22); padding: 6px 14px; border-radius: 20px; font-size: 13px; }
.result-btns     { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 14px 0 6px; }
.result-link {
    background: white; padding: 11px 18px; border-radius: 7px;
    text-decoration: none; font-weight: 600; font-size: 14px; transition: transform 0.15s;
}
.result-link:hover { transform: scale(1.04); }
.result-link.green { color: #137333; }
.result-link.blue  { color: #1967d2; }
.err-log {
    max-height: 140px; overflow-y: auto; background: rgba(0,0,0,0.18);
    border-radius: 5px; padding: 9px; margin-top: 9px; text-align: left; font-size: 12px;
}

/* â”€â”€ Download card â”€â”€ */
.dl-card {
    background: white; border-radius: 9px; padding: 18px;
    margin-top: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.08);
}
.dl-card h4 { font-size: 14px; margin-bottom: 12px; color: #333; }
.dl-list { list-style: none; padding: 0; counter-reset: dl; }
.dl-list li {
    counter-increment: dl; display: flex; gap: 11px;
    align-items: flex-start; margin-bottom: 10px; font-size: 13px; line-height: 1.5;
}
.dl-list li::before {
    content: counter(dl); background: #4285f4; color: white;
    min-width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0; margin-top: 2px;
}

/* â”€â”€ Accordion â”€â”€ */
.acc { border: 1px solid #e8e8e8; border-radius: 7px; overflow: hidden; margin-top: 12px; }
.acc + .acc { margin-top: 6px; }
.acc-btn {
    width: 100%; display: flex; justify-content: space-between; align-items: center;
    padding: 11px 14px; background: #f8f9fa; border: none; cursor: pointer;
    font-size: 13px; font-weight: 500; color: #444; text-align: left;
}
.acc-btn:hover { background: #f1f3f4; }
.acc-body { display: none; padding: 14px; background: #fafafa; font-size: 13px; color: #555; line-height: 1.6; }
.acc-body.open { display: block; }

/* â”€â”€ Help tables â”€â”€ */
.htbl { width: 100%; border-collapse: collapse; margin: 8px 0; }
.htbl td { padding: 7px 9px; border-bottom: 1px solid #eee; font-size: 12px; vertical-align: top; }
.htbl td:first-child { width: 185px; font-weight: 600; color: #333; white-space: nowrap; }
.htbl tr:last-child td { border-bottom: none; }

code {
    background: #e8e8e8; padding: 1px 5px;
    border-radius: 3px; font-family: monospace; font-size: 12px;
}
pre {
    background: #f1f3f4; padding: 11px; border-radius: 6px;
    font-size: 12px; overflow-x: auto; line-height: 1.7; margin: 8px 0;
}
.chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
.chip { background: #f1f3f4; padding: 3px 11px; border-radius: 12px; font-size: 12px; }
.chip.red { background: #fce8e6; color: #c5221f; }

.footer { text-align: center; padding: 22px; color: #bbb; font-size: 12px; }

@media (max-width: 580px) {
    .input-row { flex-direction: column; }
    .result-btns { flex-direction: column; }
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <h1>ğŸªª Student ID Card Generator</h1>
    <p>Swiss Educational College â€” generate student list + photo ZIP automatically</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-panel" id="settingsPanel">
    <button class="settings-toggle" onclick="toggleSettings()">
        <span>
            âš™ï¸ Settings
            <span class="s-badge warn" id="sBadge">âš  Setup required â€” click to open</span>
        </span>
        <span class="s-arrow" id="sArrow">â–²</span>
    </button>

    <div class="settings-body" id="settingsBody">
        <div class="callout blue">
            <strong>One-time setup.</strong> Enter both URLs and click Save â€” they are remembered in your browser for future visits.
        </div>

        <label class="field-label" for="inWebApp">
            ğŸ”— Apps Script Web App URL
            <small>â€” the backend that reads your sheets and copies photos</small>
        </label>
        <input class="url-input" type="url" id="inWebApp"
               placeholder="https://script.google.com/macros/s/AKfycbâ€¦/exec"
               oninput="onSettingsChange()" />

        <label class="field-label" for="inSheet1">
            ğŸ“‹ Photo Index Sheet URL (Sheet1), import from Student Pictures Directory
            <small>â€” Col A = Name, Col B = Email, Col C = Drive photo link, https://docs.google.com/spreadsheets/d/1D1JFXA5g9uam97Jauk4-QBwMGxB2rvVSh65bkclUvxE/edit?gid=0#gid=0</small>
        </label>
        <input class="url-input" type="url" id="inSheet1"
               placeholder="https://docs.google.com/spreadsheets/d/â€¦"
               oninput="onSettingsChange()" />

        <div style="margin-top:14px; display:flex; align-items:center; gap:12px;">
            <button class="btn btn-yellow" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
            <span id="savedOk" style="color:#137333; font-size:13px; display:none;">âœ“ Saved!</span>
        </div>

        <!-- Settings accordion help -->
        <div class="acc" style="margin-top:16px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ“‹ How to create the Apps Script and get the Web App URL <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p style="margin-bottom:8px;">The Apps Script is a Google-hosted backend. You set it up once:</p>
                <ol style="padding-left:18px; line-height:2.1;">
                    <li>Open any Google Spreadsheet â†’ <strong>Extensions â†’ Apps Script</strong></li>
                    <li>Delete any placeholder code</li>
                    <li>Paste the full contents of <code>StudentIDCards.gs</code> â†’ Save (<kbd>Ctrl+S</kbd>)</li>
                    <li>Click <strong>Deploy â†’ New deployment</strong></li>
                    <li>Click the âš™ï¸ gear icon â†’ select <strong>Web app</strong></li>
                    <li>Set <em>Execute as</em>: <strong>Me</strong></li>
                    <li>Set <em>Who has access</em>: <strong>Anyone</strong></li>
                    <li>Click <strong>Deploy</strong> â†’ grant permissions when prompted</li>
                    <li>Copy the <strong>Web app URL</strong> (starts with <code>https://script.google.com/macros/s/</code>)</li>
                    <li>Paste it in the Apps Script URL field above â†’ click <strong>ğŸ’¾ Save Settings</strong></li>
                </ol>
                <div class="callout" style="margin-top:10px;">
                    âš ï¸ <strong>After any future script change:</strong> Deploy â†’ Manage deployments â†’ âœï¸ Edit â†’ select <em>New version</em> â†’ Deploy. Skipping this means the old code keeps running.
                </div>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ“· Where is the Photo Index Sheet (Sheet1)? <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p>Sheet1 is in the <strong>Metabase_Foto</strong> Google Drive folder. It maps each student's email to their photo file on Drive.</p>
                <table class="htbl" style="margin-top:8px;">
                    <tr><td>Col A</td><td>Student name â€” ignored by the script</td></tr>
                    <tr><td>Col B</td><td>School email â€” e.g. <code>antony.aghilesh@student.swissedcol.ch</code></td></tr>
                    <tr><td>Col C</td><td>Google Drive photo URL â€” thumbnail format is fine: <code>https://drive.google.com/thumbnail?id=â€¦&sz=w200</code></td></tr>
                </table>
                <p style="margin-top:8px;">The Sheet1 spreadsheet must be accessible by the same Google account that runs the Apps Script. Open it â†’ Share â†’ add the Apps Script owner as Viewer if needed.</p>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                âŒ Settings not saving / forgotten after refresh <span>â–¼</span>
            </button>
            <div class="acc-body">
                <ul style="padding-left:18px;">
                    <li>You <strong>must click ğŸ’¾ Save Settings</strong> â€” just typing in the fields is not enough</li>
                    <li>Settings are stored in your browser's <em>localStorage</em> and survive page refreshes and tab closes on the same device and browser</li>
                    <li>They are <strong>not</strong> saved in private/incognito windows â€” use a regular browser window</li>
                    <li>If you clear browser data (cookies/cache), you will need to re-enter both URLs</li>
                    <li>If the âš  badge still shows after clicking Save, check that both fields are filled in</li>
                </ul>
            </div>
        </div>

    </div><!-- /settings-body -->
</div><!-- /settings-panel -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step active" id="step1">
    <div class="step-hdr">
        <div class="step-num"><span class="num">1</span></div>
        <div><span class="step-title">Load Class List</span> <span class="step-sub">(Sheet2)</span></div>
    </div>

    <p style="font-size:13px;color:#555;margin-bottom:10px;">
        Paste the URL of your master student list(LMS Import 20__). Columns are found automatically by header name â€”
        no need to worry about column positions.<br>
        <strong>Required headers:</strong> <code>Class</code> Â· <code>First Name Last Name</code> Â· <code>School Email</code> Â· <code>Birthday</code>
    </p>

    <div class="input-row">
        <input type="url" id="inSheet2"
               placeholder="https://docs.google.com/spreadsheets/d/â€¦"
               onkeydown="if(event.key==='Enter') loadClasses()" />
        <button class="btn btn-blue" id="btnLoad" onclick="loadClasses()">Load Classes â†’</button>
    </div>

    <div class="status-bar hidden" id="st1"></div>

    <div class="acc" style="margin-top:14px;">
        <button class="acc-btn" onclick="toggleAcc(this)">
            â“ "Load Classes" button not working â€” what to check <span>â–¼</span>
        </button>
        <div class="acc-body">
            <table class="htbl">
                <tr>
                    <td>Button does nothing</td>
                    <td>The Apps Script URL must be saved first. Open <strong>âš™ï¸ Settings</strong> at the top, paste the Web App URL, and click <strong>ğŸ’¾ Save Settings</strong>. The tool cannot contact Google without it.</td>
                </tr>
                <tr>
                    <td>âŒ Network / fetch error</td>
                    <td>The Apps Script must be deployed as a Web App with <em>Who has access: Anyone</em>. Go to Apps Script â†’ <strong>Deploy â†’ Manage deployments â†’ Edit â†’ New version â†’ Deploy</strong>. Also make sure you are using the latest <code>StudentIDCards.gs</code> file (v5, which uses <code>doGet</code> instead of <code>doPost</code>).</td>
                </tr>
                <tr>
                    <td>âŒ "Cannot open Sheet2"</td>
                    <td>The Google account running the Apps Script must have access to Sheet2. Open Sheet2 â†’ Share â†’ add the Apps Script owner's email as Viewer.</td>
                </tr>
                <tr>
                    <td>âŒ "Class column not found"</td>
                    <td>Row 1 of Sheet2 must have header cells. The header <code>Class</code> must exist (case-insensitive). Check for extra spaces or typos in the header row.</td>
                </tr>
                <tr>
                    <td>âš ï¸ 0 students found</td>
                    <td>Rows with no <code>@</code> in the email column are skipped. Check that the <code>School Email</code> column is correctly labelled and populated.</td>
                </tr>
                <tr>
                    <td>âŒ "Invalid URL"</td>
                    <td>Copy the full URL from your browser address bar while Sheet2 is open. It must start with <code>https://docs.google.com/spreadsheets/d/</code>.</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="acc">
        <button class="acc-btn" onclick="toggleAcc(this)">
            ğŸ“‹ Required Sheet2 structure and column details <span>â–¼</span>
        </button>
        <div class="acc-body">
            <p style="margin-bottom:8px;">Sheet2 needs a <strong>header row (row 1)</strong>. Any extra columns are ignored. The four columns below are required:</p>
            <table class="htbl">
                <tr>
                    <td><code>Class</code></td>
                    <td>Full class name â€” e.g. <code>26-T1-Class-BBA</code> or <code>25-T4-Class-MBA</code>. The prefix before "Class-" is used to group students and assign validity periods.</td>
                </tr>
                <tr>
                    <td><code>First Name Last Name</code></td>
                    <td>Combined name in one column. Nicknames in dashes are stripped automatically:<br>
                        <code>-Ann- Thi Dung Phung</code> â†’ <code>Thi Dung Phung</code><br>
                        <code>Phan -Annabelle- Thi Bich Ngan</code> â†’ <code>Phan Thi Bich Ngan</code><br>
                        <code>- Phuong Anh Pham</code> â†’ <code>Phuong Anh Pham</code>
                    </td>
                </tr>
                <tr>
                    <td><code>School Email</code></td>
                    <td>Unique student identifier used to match with the Photo Index. Must contain <code>@</code>.</td>
                </tr>
                <tr>
                    <td><code>Birthday</code></td>
                    <td>Any date format is accepted: <code>10/08/2006</code>, <code>10.08.2006</code>, <code>2006-08-10</code>. Output is always <code>DD/MM/YYYY</code>.</td>
                </tr>
            </table>
        </div>
    </div>
</div><!-- /step1 -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step locked" id="step2">
    <div class="step-hdr">
        <div class="step-num"><span class="num">2</span></div>
        <div><span class="step-title">Set Validity Periods</span></div>
    </div>

    <!-- Locked placeholder â€” shown until step 1 succeeds -->
    <div id="step2locked" class="locked-msg">
        ğŸ”’ Complete Step 1 first â€” classes will appear here automatically
    </div>

    <!-- Actual content â€” hidden until step 1 succeeds -->
    <div id="step2content" style="display:none;">
        <p style="font-size:13px;color:#555;margin-bottom:10px;">
            Students are grouped by class prefix. Set the validity period for each group in
            <code>MM/YYYY-MM/YYYY</code> format. Leave blank to <strong>skip</strong> that group (those students won't appear in the output).
        </p>

        <table class="vtable">
            <thead><tr>
                <th>Class Prefix</th>
                <th>Students</th>
                <th>Validity Period</th>
                <th></th>
            </tr></thead>
            <tbody id="classBody"></tbody>
        </table>

        <div class="status-bar hidden" id="st2"></div>
        <div class="chips" id="classChips"></div>

        <div class="acc" style="margin-top:12px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                â“ What are validity periods? How are they formatted? <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p>The validity period appears on the ID card to show when it is valid. It is based on the student's intake term:</p>
                <table class="htbl" style="margin:8px 0;">
                    <tr><td><code>25-T3-Class-â€¦</code></td><td>Intake July 2025 â†’ validity <code>07/2025-06/2026</code></td></tr>
                    <tr><td><code>25-T4-Class-â€¦</code></td><td>Intake October 2025 â†’ validity <code>10/2025-09/2026</code></td></tr>
                    <tr><td><code>26-T1-Class-â€¦</code></td><td>Intake January 2026 â†’ validity <code>01/2026-12/2026</code></td></tr>
                    <tr><td><code>26-T2-Class-â€¦</code></td><td>Intake April 2026 â†’ validity <code>04/2026-03/2027</code></td></tr>
                </table>
                <p>Values are pre-filled automatically. You can edit any field â€” format must be <code>MM/YYYY-MM/YYYY</code>.</p>
                <p style="margin-top:6px;">To add a new term permanently for future use, edit the <code>DEFAULT_VALIDITY</code> object at the top of the <code>&lt;script&gt;</code> in <code>index.html</code>.</p>
            </div>
        </div>
    </div>
</div><!-- /step2 -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step locked" id="step3">
    <div class="step-hdr">
        <div class="step-num"><span class="num">3</span></div>
        <div><span class="step-title">Generate &amp; Download</span></div>
    </div>

    <!-- Locked placeholder -->
    <div id="step3locked" class="locked-msg">
        ğŸ”’ Complete Steps 1 &amp; 2 first
    </div>

    <!-- Actual content -->
    <div id="step3content" style="display:none;">
        <p style="font-size:13px;color:#555;margin-bottom:6px;">
            The Apps Script will: <strong>(1)</strong> match each student's email to their photo in Sheet1,
            <strong>(2)</strong> copy &amp; rename all photos to a new Drive folder,
            <strong>(3)</strong> write the formatted student list sheet with clickable relative photo links.
        </p>
        <p style="font-size:13px;color:#c5221f;margin-bottom:16px;">
            â± Takes <strong>1â€“3 minutes</strong> for ~90 students. <strong>Do not close this tab</strong> while it runs.
        </p>

        <div style="text-align:center; margin-bottom:14px;">
            <button class="btn btn-green btn-lg" id="btnGen" onclick="generate()">âš¡ Generate Now</button>
        </div>

        <div id="progWrap" style="display:none;" class="prog-wrap">
            <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
            <div class="prog-label" id="progLabel">Startingâ€¦</div>
        </div>

        <div class="status-bar hidden" id="st3"></div>
        <div id="result"></div>

        <div class="acc" style="margin-top:16px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                â“ Generate failed â€” error messages explained <span>â–¼</span>
            </button>
            <div class="acc-body">
                <table class="htbl">
                    <tr>
                        <td>âŒ "Failed to fetch" / network error</td>
                        <td>The Apps Script is not responding to GET requests. Ensure you have the latest <code>StudentIDCards.gs</code> (uses <code>doGet</code>) and have <strong>re-deployed as a New version</strong>. The previous version used <code>doPost</code> which is blocked by browsers when called from GitHub Pages.</td>
                    </tr>
                    <tr>
                        <td>âŒ "0 students matched"</td>
                        <td>No class prefixes in Sheet2 match entries in the validity table. Check Step 2 â€” at least one row must have a filled validity period.</td>
                    </tr>
                    <tr>
                        <td>âš ï¸ Many "photo not in index"</td>
                        <td>Those students are in Sheet2 but not in Sheet1. Open Sheet1 and add a row for each missing student: Col B = email, Col C = Drive photo thumbnail URL. Then re-run â€” already-copied photos are skipped.</td>
                    </tr>
                    <tr>
                        <td>âŒ "Cannot access file"</td>
                        <td>A photo Drive file is not shared with the Apps Script owner. The owner needs at least Viewer access to the file or its parent folder.</td>
                    </tr>
                    <tr>
                        <td>â± Times out at ~6 min</td>
                        <td>Google Apps Script has a 6-minute execution limit. For 100+ students, blank half the validity periods (those students are skipped), run, then restore and run again. Already-copied photos are never re-downloaded so there is no duplication.</td>
                    </tr>
                    <tr>
                        <td>âš ï¸ 0 photos copied</td>
                        <td>Check that the Photo Index URL in Settings points to Sheet1 (not Sheet2) and that Col C contains Google Drive URLs (must include <code>drive.google.com</code>).</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ“¥ How to download and assemble the final package <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p style="margin-bottom:10px;">After a successful run, two green/blue buttons appear. Here is what to do:</p>
                <ol style="padding-left:18px; line-height:2.1;">
                    <li>Click <strong>Open Student List</strong> â†’ in Google Sheets: <strong>File â†’ Download â†’ Microsoft Excel (.xlsx)</strong> â†’ save to a local folder (e.g. <code>StudentIDCards/</code>)</li>
                    <li>Click <strong>Open Photos Folder</strong> â†’ in Google Drive: right-click the folder â†’ <strong>Download</strong> â†’ Google creates a ZIP â†’ save and unzip it</li>
                    <li><strong>Rename</strong> the unzipped folder to exactly <code>Photos</code> (capital P â€” Google adds a timestamp to the name)</li>
                    <li>Move the <code>Photos</code> folder into <code>StudentIDCards/</code> so it sits <strong>next to</strong> the <code>.xlsx</code> file</li>
                    <li>Open the Excel â†’ click any cell in the <strong>Link_to_Cropped_Photo</strong> column â†’ the photo opens locally ğŸ‰</li>
                    <li>Optional: ZIP the entire <code>StudentIDCards/</code> folder to share â€” links work on any machine</li>
                </ol>
                <pre>StudentIDCards/
  â”œâ”€â”€ StudentIDCards.xlsx
  â””â”€â”€ Photos/                  â† must be named exactly "Photos"
        â”œâ”€â”€ antony.aghilesh@student.swissedcol.ch.jpg
        â”œâ”€â”€ sahil.koshiya@student.swissedcol.ch.jpg
        â””â”€â”€ â€¦</pre>
                <div class="callout" style="margin-top:8px;">
                    âš ï¸ The folder <strong>must</strong> be named <code>Photos</code> with a capital P. Google Drive downloads folders with a timestamp in the name (e.g. <code>Photos_20260220_1430</code>) â€” rename it before opening the Excel file or the links will not resolve.
                </div>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ”„ Re-running to fix missing photos <span>â–¼</span>
            </button>
            <div class="acc-body">
                <ul style="padding-left:18px;">
                    <li>Add the missing student rows to Sheet1 (Col B = email, Col C = Drive photo thumbnail URL)</li>
                    <li>Click <strong>Generate Now</strong> again â€” the script checks the new <code>Photos_â€¦</code> folder and skips files already copied</li>
                    <li>A new <code>Photos_â€¦</code> folder is created each run â€” download from the latest one</li>
                    <li>The <code>ID_Cards_Output</code> sheet is fully replaced each run with the complete updated list</li>
                    <li>There is no need to change anything in Steps 1 or 2 for a re-run</li>
                </ul>
            </div>
        </div>
    </div>
</div><!-- /step3 -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOW IT WORKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="acc" style="margin-bottom:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.07); overflow:hidden;">
    <button class="acc-btn" onclick="toggleAcc(this)" style="font-size:14px; padding:14px 18px;">
        â„¹ï¸ How the whole system works â€” full overview <span>â–¼</span>
    </button>
    <div class="acc-body" style="background:white;">
        <p style="margin-bottom:10px;"><strong>Three components work together:</strong></p>
        <table class="htbl" style="margin-bottom:14px;">
            <tr>
                <td>ğŸ“‹ Sheet1<br><small style="font-weight:400;">(Photo Index)</small></td>
                <td>Maps each student email to their Google Drive photo. Maintained by admin in the Metabase_Foto folder. The script reads Col B (email) and Col C (Drive thumbnail URL) to locate and copy each photo.</td>
            </tr>
            <tr>
                <td>ğŸ“Š Sheet2<br><small style="font-weight:400;">(Class List)</small></td>
                <td>Master student list â€” one row per student with Class, Name, Email, Birthday. Only students in Sheet2 appear in the output. The class name determines the validity period.</td>
            </tr>
            <tr>
                <td>âš™ï¸ Apps Script<br><small style="font-weight:400;">(Backend)</small></td>
                <td>Runs on Google's servers. Reads both sheets, copies and renames photos, writes the formatted output sheet with relative hyperlinks. No local installation required.</td>
            </tr>
        </table>

        <p style="margin-bottom:8px;"><strong>What happens when you click Generate:</strong></p>
        <ol style="padding-left:18px; line-height:2.1; margin-bottom:14px;">
            <li>Reads all rows from Sheet1 â†’ builds lookup: <em>email â†’ Drive file ID</em> (extracted from the thumbnail URL)</li>
            <li>Reads all rows from Sheet2 â†’ filters to students whose class prefix matches a validity period</li>
            <li>For each student: removes nickname patterns from the name, formats birthday as <code>DD/MM/YYYY</code></li>
            <li>Looks up the student's email in the Sheet1 index â†’ opens the Drive photo file â†’ makes a copy named <code>email.jpg</code> â†’ saves to a new <code>Photos_â€¦</code> Drive folder</li>
            <li>Writes the <code>ID_Cards_Output</code> sheet with 6 columns: Studies at | Name | School Email | Born | Validity | Link_to_Cropped_Photo</li>
            <li>The photo column uses <code>=HYPERLINK("Photos/email.jpg","email.jpg")</code> â€” a relative path that works when the Photos folder is placed next to the Excel file</li>
        </ol>

        <p style="margin-bottom:6px;"><strong>Name cleaning examples:</strong></p>
        <table class="htbl">
            <tr><td><code>-Ann- Thi Dung Phung</code></td><td>â†’ <code>Thi Dung Phung</code></td></tr>
            <tr><td><code>Phan -Annabelle- Thi Bich Ngan</code></td><td>â†’ <code>Phan Thi Bich Ngan</code></td></tr>
            <tr><td><code>- Phuong Anh Pham</code></td><td>â†’ <code>Phuong Anh Pham</code></td></tr>
        </table>

        <p style="margin-top:12px; margin-bottom:6px;"><strong>Output sheet columns:</strong></p>
        <table class="htbl">
            <tr><td>Studies at</td><td>Always "Swiss Educational College"</td></tr>
            <tr><td>Name</td><td>Cleaned full name</td></tr>
            <tr><td>School Email</td><td>The student's email address</td></tr>
            <tr><td>Born</td><td>Birthday in <code>DD/MM/YYYY</code> format</td></tr>
            <tr><td>Validity</td><td>Card validity period in <code>MM/YYYY-MM/YYYY</code> format</td></tr>
            <tr><td>Link_to_Cropped_Photo</td><td>Clickable relative link to the renamed photo â€” works offline once Photos folder is placed next to the Excel file</td></tr>
        </table>
    </div>
</div>

<div class="footer">Swiss Educational College Â· Student ID Card Generator</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// Default validity per term prefix â€” edit here to add new intakes
var DEFAULT_VALIDITY = {
    '25-T3-': '07/2025-06/2026',
    '25-T4-': '10/2025-09/2026',
    '26-T1-': '01/2026-12/2026',
    '26-T2-': '04/2026-03/2027',
    '26-T3-': '07/2026-06/2027',
    '26-T4-': '10/2026-09/2027'
};

var WEB_APP_URL = '';
var SHEET1_URL  = '';

// â”€â”€ Page init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = function() {
    WEB_APP_URL = localStorage.getItem('idcard_webapp') || '';
    SHEET1_URL  = localStorage.getItem('idcard_sheet1') || '';

    document.getElementById('inWebApp').value = WEB_APP_URL;
    document.getElementById('inSheet1').value = SHEET1_URL;

    if (WEB_APP_URL) document.getElementById('inWebApp').classList.add('set');
    if (SHEET1_URL)  document.getElementById('inSheet1').classList.add('set');

    updateBadge();

    // Auto-open settings if not configured yet
    if (!WEB_APP_URL || !SHEET1_URL) {
        document.getElementById('settingsBody').classList.remove('hidden');
        document.getElementById('sArrow').textContent = 'â–²';
    } else {
        document.getElementById('settingsBody').classList.add('hidden');
        document.getElementById('sArrow').textContent = 'â–¼';
    }
};

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSettings() {
    var body  = document.getElementById('settingsBody');
    var arrow = document.getElementById('sArrow');
    if (body.classList.contains('hidden')) {
        body.classList.remove('hidden');
        arrow.textContent = 'â–²';
    } else {
        body.classList.add('hidden');
        arrow.textContent = 'â–¼';
    }
}

function saveSettings() {
    WEB_APP_URL = document.getElementById('inWebApp').value.trim();
    SHEET1_URL  = document.getElementById('inSheet1').value.trim();
    localStorage.setItem('idcard_webapp', WEB_APP_URL);
    localStorage.setItem('idcard_sheet1', SHEET1_URL);

    document.getElementById('inWebApp').classList.toggle('set', !!WEB_APP_URL);
    document.getElementById('inSheet1').classList.toggle('set', !!SHEET1_URL);
    updateBadge();

    var ok = document.getElementById('savedOk');
    ok.style.display = 'inline';
    setTimeout(function(){ ok.style.display = 'none'; }, 2500);
}

function onSettingsChange() {
    document.getElementById('savedOk').style.display = 'none';
}

function updateBadge() {
    var done  = WEB_APP_URL && SHEET1_URL;
    var badge = document.getElementById('sBadge');
    var panel = document.getElementById('settingsPanel');
    badge.textContent = done ? 'âœ“ Configured' : 'âš  Setup required â€” click to open';
    badge.className   = 's-badge ' + (done ? 'good' : 'warn');
    panel.className   = 'settings-panel' + (done ? ' ok' : '');
}

// â”€â”€ Accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAcc(btn) {
    var body = btn.nextElementSibling;
    var open = body.classList.toggle('open');
    // Flip the arrow (last child of btn)
    var arrow = btn.querySelector('span:last-child');
    if (arrow) arrow.textContent = open ? 'â–²' : 'â–¼';
}

// â”€â”€ Step 1: Load classes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadClasses() {
    var s2 = document.getElementById('inSheet2').value.trim();
    var wa = document.getElementById('inWebApp').value.trim() || WEB_APP_URL;

    if (!wa) {
        showBar('st1', 'error',
            'âŒ Apps Script URL not saved. Open âš™ï¸ Settings at the top, paste your Web App URL, and click ğŸ’¾ Save Settings.');
        openSettings();
        return;
    }
    WEB_APP_URL = wa;  // use whatever is currently in the field even if not saved yet

    if (!s2) {
        showBar('st1', 'error', 'âŒ Please paste your Sheet2 URL in the field above.'); return;
    }
    if (s2.indexOf('docs.google.com/spreadsheets') === -1) {
        showBar('st1', 'error', 'âŒ That doesn\'t look like a Google Sheets URL. Copy it directly from your browser address bar while Sheet2 is open.'); return;
    }

    showBar('st1', 'info', 'â³ Connecting to Apps Script and reading Sheet2â€¦');
    document.getElementById('btnLoad').disabled = true;

    callScript({ action: 'loadClasses', sheet2Url: s2 })
        .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Unknown error returned by Apps Script');
            buildClassTable(data.classes, data.totalStudents);
            showBar('st1', 'success',
                'âœ… Found ' + data.totalStudents + ' students across ' + data.classes.length + ' class group(s). Review validity periods in Step 2 then generate.');
            setStepDone('step1');
            unlockStep('step2');
            unlockStep('step3');
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(function(e) {
            showBar('st1', 'error', 'âŒ ' + e.message + ' â€” expand the troubleshooting section above for help.');
            document.getElementById('step1').className = 'step errored';
        })
        .finally(function() {
            document.getElementById('btnLoad').disabled = false;
        });
}

function unlockStep(id) {
    var step = document.getElementById(id);
    step.className = 'step active';
    var locked  = document.getElementById(id + 'locked');
    var content = document.getElementById(id + 'content');
    if (locked)  locked.style.display  = 'none';
    if (content) content.style.display = 'block';
}

function setStepDone(id) {
    document.getElementById(id).className = 'step done';
}

function buildClassTable(classes, total) {
    var tbody = document.getElementById('classBody');
    tbody.innerHTML = '';
    var inc = 0, skip = 0;

    classes.forEach(function(c) {
        var def = guessValidity(c.prefix);
        if (def) inc += c.count; else skip += c.count;
        var safeId = 'v_' + c.prefix.replace(/[^a-z0-9]/gi, '_');
        var tr = document.createElement('tr');
        tr.innerHTML =
            '<td><span class="cbadge">' + esc(c.prefix) + '</span></td>' +
            '<td style="color:#666;">' + c.count + '</td>' +
            '<td>' +
                '<input class="val-inp ' + (def ? 'ok' : 'skip') + '"' +
                ' id="' + safeId + '"' +
                ' data-prefix="' + esc(c.prefix) + '"' +
                ' value="' + esc(def) + '"' +
                ' placeholder="MM/YYYY-MM/YYYY"' +
                ' oninput="onValChange(this)">' +
                (def ? '' : ' <span style="font-size:11px;color:#ea4335;margin-left:6px;">will be skipped</span>') +
            '</td>' +
            '<td style="font-size:18px;">' + (def ? 'âœ…' : 'âš ï¸') + '</td>';
        tbody.appendChild(tr);
    });

    // Summary bar
    if (skip > 0) {
        showBar('st2', 'warning', 'âš ï¸ ' + skip + ' student(s) in unrecognised groups â€” add a validity period to include them, or leave blank to skip.');
    } else {
        showBar('st2', 'success', 'âœ… All ' + total + ' students have a validity period assigned.');
    }

    document.getElementById('classChips').innerHTML =
        '<div class="chip">ğŸ‘¥ ' + total + ' total</div>' +
        '<div class="chip">âœ… ' + inc + ' included</div>' +
        (skip ? '<div class="chip red">âš ï¸ ' + skip + ' skipped</div>' : '');
}

function onValChange(inp) {
    var v = inp.value.trim();
    inp.classList.toggle('ok',   !!v);
    inp.classList.toggle('skip', !v);
    var icon = inp.closest('tr').cells[3];
    if (icon) icon.textContent = v ? 'âœ…' : 'âš ï¸';
}

function guessValidity(prefix) {
    for (var k in DEFAULT_VALIDITY) {
        if (DEFAULT_VALIDITY.hasOwnProperty(k)) {
            if (prefix.indexOf(k) === 0 || prefix.substring(0, 7) === k.substring(0, 7))
                return DEFAULT_VALIDITY[k];
        }
    }
    return '';
}

// â”€â”€ Step 3: Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generate() {
    var s1 = document.getElementById('inSheet1').value.trim() || SHEET1_URL;
    var s2 = document.getElementById('inSheet2').value.trim();

    if (!WEB_APP_URL) { showBar('st3','error','âŒ Apps Script URL not set â€” open âš™ï¸ Settings.'); openSettings(); return; }
    if (!s1)          { showBar('st3','error','âŒ Photo Index URL (Sheet1) not set â€” open âš™ï¸ Settings.'); openSettings(); return; }
    if (!s2)          { showBar('st3','error','âŒ Sheet2 URL missing â€” complete Step 1 first.'); return; }

    var validityMap = {};
    var inputs = document.querySelectorAll('.val-inp');
    for (var i = 0; i < inputs.length; i++) {
        var p = inputs[i].getAttribute('data-prefix');
        var v = inputs[i].value.trim();
        if (p && v) validityMap[p] = v;
    }
    if (!Object.keys(validityMap).length) {
        showBar('st3','error','âŒ No validity periods configured â€” fill in at least one row in Step 2.'); return;
    }

    document.getElementById('btnGen').disabled = true;
    document.getElementById('result').innerHTML = '';
    document.getElementById('progWrap').style.display = 'block';
    setProgress(8, 'Sending request to Apps Scriptâ€¦');
    showBar('st3', 'info', 'â³ Processing â€” do not close this tab. This takes 1â€“3 minutes.');

    callScript({ action: 'generate', sheet1Url: s1, sheet2Url: s2, validityMap: validityMap })
        .then(function(res) {
            setProgress(100, 'Complete!');
            if (!res.success) throw new Error(res.error || 'Generation failed â€” check Apps Script execution log for details');
            showBar('st3', 'success',
                'âœ… ' + res.studentsCount + ' students processed â€” ' +
                res.photoOk + ' photos copied, ' + (res.photoErrors ? res.photoErrors.length : 0) + ' missing.');
            renderResult(res);
            setStepDone('step3');
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(function(e) {
            document.getElementById('progWrap').style.display = 'none';
            setProgress(0, '');
            showBar('st3', 'error', 'âŒ ' + e.message);
            document.getElementById('step3').className = 'step errored';
        })
        .finally(function() {
            document.getElementById('btnGen').disabled = false;
        });
}

function renderResult(res) {
    var errs     = res.photoErrors || [];
    var hasErrs  = errs.length > 0;
    var errBlock = hasErrs
        ? '<div class="err-log"><strong style="font-size:11px;">Missing photos (' + errs.length + ') â€” add to Sheet1 and re-run:</strong><br>' +
          errs.map(function(e){ return '<div>â€¢ ' + esc(e) + '</div>'; }).join('') + '</div>'
        : '';

    document.getElementById('result').innerHTML =
        '<div class="result-box ' + (hasErrs ? 'warn' : '') + '">' +
            '<h3>' + (hasErrs ? 'âš ï¸ Done â€” some photos missing' : 'âœ… Generation Complete!') + '</h3>' +
            '<div class="result-stats">' +
                '<div class="result-stat">ğŸ‘¥ ' + res.studentsCount + ' students</div>' +
                '<div class="result-stat">ğŸ“¸ ' + res.photoOk + ' photos</div>' +
                (hasErrs ? '<div class="result-stat">âš ï¸ ' + errs.length + ' missing</div>' : '') +
            '</div>' +
            '<div class="result-btns">' +
                '<a class="result-link green" href="' + esc(res.spreadsheetUrl) + '" target="_blank">ğŸ“Š Open Student List</a>' +
                '<a class="result-link blue"  href="' + esc(res.photoFolderUrl) + '" target="_blank">ğŸ“ Open Photos Folder</a>' +
            '</div>' +
            errBlock +
        '</div>' +
        '<div class="dl-card">' +
            '<h4>ğŸ“¥ Download &amp; assemble</h4>' +
            '<ol class="dl-list">' +
                '<li><strong>Open Student List</strong> â†’ File â†’ Download â†’ Microsoft Excel (.xlsx) â†’ save to e.g. <code>StudentIDCards/</code></li>' +
                '<li><strong>Open Photos Folder</strong> â†’ right-click â†’ Download â†’ Google creates a ZIP â†’ save and unzip</li>' +
                '<li>Rename the unzipped folder to exactly <code>Photos</code> (Google adds a timestamp to the name)</li>' +
                '<li>Place the <code>Photos</code> folder next to the <code>.xlsx</code> file in the same directory</li>' +
                '<li>Open the Excel â†’ click any cell in <strong>Link_to_Cropped_Photo</strong> â†’ photo opens ğŸ‰</li>' +
                '<li>Optional: ZIP the entire folder to share â€” links work on any machine</li>' +
            '</ol>' +
            '<div class="callout" style="margin-top:6px;">âš ï¸ Rename the Photos folder to exactly <code>Photos</code> (capital P) before opening the Excel â€” otherwise the links will not resolve.</div>' +
        '</div>';
}

// â”€â”€ Network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function callScript(payload) {
    var base = WEB_APP_URL || document.getElementById('inWebApp').value.trim();
    if (!base) return Promise.reject(new Error('Apps Script URL not configured â€” open âš™ï¸ Settings.'));

    var url = base + '?payload=' + encodeURIComponent(JSON.stringify(payload));

    return fetch(url, { method: 'GET', redirect: 'follow' })
        .catch(function(err) {
            throw new Error(
                'Cannot reach the Apps Script. Likely causes: ' +
                '(1) wrong URL in Settings, ' +
                '(2) not deployed as Web App with "Who has access: Anyone", ' +
                '(3) need to re-deploy after updating the script. ' +
                'Network detail: ' + err.message
            );
        })
        .then(function(response) {
            if (!response.ok) throw new Error('HTTP ' + response.status + ' from Apps Script â€” try re-deploying as a new version.');
            return response.text();
        })
        .then(function(text) {
            try { return JSON.parse(text); }
            catch(e) { throw new Error('Apps Script returned unexpected content (not JSON). Re-deploy using the latest StudentIDCards.gs. Preview: ' + text.substring(0, 200)); }
        });
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBar(id, type, msg) {
    var el = document.getElementById(id);
    el.className    = 'status-bar ' + type;
    el.textContent  = msg;
}

function setProgress(pct, label) {
    document.getElementById('progFill').style.width  = pct + '%';
    document.getElementById('progLabel').textContent = label;
}

function openSettings() {
    document.getElementById('settingsBody').classList.remove('hidden');
    document.getElementById('sArrow').textContent = 'â–²';
}

function esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
