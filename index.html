<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student ID Card Generator â€” Swiss Educational College</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px; margin: 0 auto; padding: 20px;
    background: #f0f2f5; line-height: 1.6; color: #333;
}
.header {
    text-align: center; margin-bottom: 24px;
    padding-bottom: 20px; border-bottom: 3px solid #c8102e;
}
.header h1 { color: #c8102e; font-size: 1.8em; margin-bottom: 4px; }
.header p  { color: #666; font-size: 1em; }

/* â”€â”€ Settings â”€â”€ */
.settings-panel {
    border-radius: 10px; margin-bottom: 18px; overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #ffc107; background: #fffde7;
}
.settings-panel.ok { border-color: #34a853; background: white; }
.settings-toggle {
    width: 100%; display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; background: transparent; border: none;
    cursor: pointer; font-size: 14px; font-weight: 600; color: #333; text-align: left;
}
.settings-toggle:hover { background: rgba(0,0,0,0.03); }
.s-badge {
    display: inline-block; font-size: 11px; font-weight: 600;
    padding: 2px 9px; border-radius: 10px; margin-left: 8px;
}
.s-badge.warn { background: #fce8e6; color: #c5221f; }
.s-badge.good { background: #e6f4ea; color: #137333; }
.s-arrow { font-size: 12px; color: #888; }
.settings-body { padding: 0 18px 18px; }
.settings-body.hidden { display: none; }
.field-label { display: block; font-size: 13px; font-weight: 600; margin: 14px 0 5px; color: #333; }
.field-label small { font-weight: 400; color: #888; }
.url-input {
    width: 100%; padding: 10px 13px; border: 2px solid #ddd;
    border-radius: 6px; font-size: 13px; font-family: monospace;
}
.url-input:focus { outline: none; border-color: #4285f4; }
.url-input.set { border-color: #34a853; background: #f8fff9; }

/* â”€â”€ Steps â”€â”€ */
.step {
    background: white; border-radius: 10px; padding: 20px 22px;
    margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 5px solid #ddd;
}
.step.active  { border-left-color: #4285f4; }
.step.done    { border-left-color: #34a853; background: #f9fff9; }
.step.locked  { border-left-color: #ddd; background: #fafafa; }
.step.errored { border-left-color: #ea4335; }
.step-hdr { display: flex; align-items: center; margin-bottom: 14px; }
.step-num {
    min-width: 34px; height: 34px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; margin-right: 12px;
    background: #ddd; color: #888;
}
.step.active .step-num  { background: #4285f4; color: white; }
.step.done   .step-num  { background: #34a853; color: white; }
.step.done   .step-num::after { content: "âœ“"; }
.step.done   .step-num .num   { display: none; }
.step-title { font-size: 1.05em; font-weight: 600; }
.step-sub   { font-size: 12px; color: #999; margin-left: 5px; }
.locked-msg { text-align: center; padding: 20px; color: #aaa; font-size: 14px; }

/* â”€â”€ Buttons â”€â”€ */
.btn {
    display: inline-block; padding: 10px 20px; border-radius: 6px; border: none;
    cursor: pointer; font-size: 14px; font-weight: 600; margin: 4px 4px 4px 0;
    text-decoration: none; transition: filter 0.15s;
}
.btn:hover:not(:disabled) { filter: brightness(0.9); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-blue   { background: #4285f4; color: white; }
.btn-green  { background: #34a853; color: white; }
.btn-yellow { background: #fbbc04; color: #333; }
.btn-lg     { font-size: 16px; padding: 14px 36px; }
.input-row  { display: flex; gap: 10px; margin: 8px 0; }
.input-row input {
    flex: 1; padding: 10px 13px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;
}
.input-row input:focus { outline: none; border-color: #4285f4; }

/* â”€â”€ Status bars â”€â”€ */
.sbar { margin: 10px 0; padding: 10px 14px; border-radius: 6px; font-size: 13px; display: none; }
.sbar.show    { display: block; }
.sbar.info    { background: #e8f0fe; color: #1967d2; }
.sbar.success { background: #e6f4ea; color: #137333; }
.sbar.error   { background: #fce8e6; color: #c5221f; }
.sbar.warning { background: #fef7e0; color: #b06000; }

/* â”€â”€ Callouts â”€â”€ */
.callout {
    border-left: 4px solid #ffc107; background: #fff8e1;
    padding: 10px 14px; border-radius: 0 6px 6px 0;
    margin: 10px 0; font-size: 13px; color: #555;
}
.callout.blue  { border-color: #4285f4; background: #e8f0fe; color: #1967d2; }
.callout.green { border-color: #34a853; background: #e6f4ea; color: #137333; }
.callout.red   { border-color: #ea4335; background: #fce8e6; color: #c5221f; }

/* â”€â”€ Class validity table â”€â”€ */
.vtable { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
.vtable th {
    background: #f1f3f4; padding: 9px 11px; text-align: left;
    font-weight: 600; color: #444; border-bottom: 2px solid #e0e0e0;
}
.vtable td { padding: 8px 11px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
.vtable tr:last-child td { border-bottom: none; }
.cbadge {
    display: inline-block; background: #e8f0fe; color: #1967d2;
    padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; font-family: monospace;
}
.val-inp {
    padding: 7px 9px; border: 1.5px solid #ddd; border-radius: 5px;
    font-size: 13px; width: 180px; font-family: monospace;
}
.val-inp:focus { outline: none; border-color: #4285f4; }
.val-inp.ok   { border-color: #34a853; background: #f8fff9; }
.val-inp.skip { border-color: #ea4335; color: #bbb; }

/* â”€â”€ Progress â”€â”€ */
.prog-bar  { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 10px 0 4px; }
.prog-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #4285f4, #34a853); width: 0%; transition: width 0.5s ease; }
.prog-lbl  { font-size: 12px; color: #666; }

/* â”€â”€ Result box â”€â”€ */
.result-box {
    border-radius: 10px; padding: 22px; color: white; text-align: center; margin-top: 12px;
    background: linear-gradient(135deg, #34a853, #1a7a37);
}
.result-box.warn { background: linear-gradient(135deg, #f9a825, #e65100); }
.result-box h3   { font-size: 1.3em; margin-bottom: 8px; }
.result-stats    { display: flex; justify-content: center; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
.result-stat     { background: rgba(255,255,255,0.22); padding: 6px 14px; border-radius: 20px; font-size: 13px; }
.err-log {
    max-height: 130px; overflow-y: auto; background: rgba(0,0,0,0.18);
    border-radius: 5px; padding: 9px; margin-top: 9px; text-align: left; font-size: 12px;
}

/* â”€â”€ Drive folder card â”€â”€ */
.folder-card {
    background: white; border-radius: 10px; padding: 22px;
    margin-top: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #34a853;
}
.folder-card h4 { font-size: 15px; color: #137333; margin-bottom: 4px; }
.folder-card .folder-path {
    font-family: monospace; font-size: 12px; color: #666;
    background: #f1f3f4; padding: 5px 10px; border-radius: 5px;
    display: inline-block; margin-bottom: 14px;
}
.folder-tree {
    background: #f8f9fa; border-radius: 7px; padding: 14px;
    font-family: monospace; font-size: 13px; line-height: 2;
    margin-bottom: 14px; color: #333;
}
.folder-tree a { color: #1967d2; text-decoration: none; }
.folder-tree a:hover { text-decoration: underline; }
.dl-list { list-style: none; padding: 0; counter-reset: dl; }
.dl-list li {
    counter-increment: dl; display: flex; gap: 11px;
    align-items: flex-start; margin-bottom: 10px; font-size: 13px; line-height: 1.5;
}
.dl-list li::before {
    content: counter(dl); background: #4285f4; color: white;
    min-width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; flex-shrink: 0; margin-top: 2px;
}

/* â”€â”€ Accordion â”€â”€ */
.acc { border: 1px solid #e8e8e8; border-radius: 7px; overflow: hidden; margin-top: 12px; }
.acc + .acc { margin-top: 6px; }
.acc-btn {
    width: 100%; display: flex; justify-content: space-between; align-items: center;
    padding: 11px 14px; background: #f8f9fa; border: none; cursor: pointer;
    font-size: 13px; font-weight: 500; color: #444; text-align: left;
}
.acc-btn:hover { background: #f1f3f4; }
.acc-body { display: none; padding: 14px; background: #fafafa; font-size: 13px; color: #555; line-height: 1.6; }
.acc-body.open { display: block; }
.acc-body p { margin-bottom: 8px; }
.acc-body ul, .acc-body ol { padding-left: 18px; margin: 6px 0; }
.acc-body li { margin: 5px 0; }

/* â”€â”€ Tables â”€â”€ */
.htbl { width: 100%; border-collapse: collapse; margin: 8px 0; }
.htbl td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 12px; vertical-align: top; }
.htbl td:first-child { width: 190px; font-weight: 600; color: #333; white-space: nowrap; }
.htbl tr:last-child td { border-bottom: none; }
code { background: #e8e8e8; padding: 1px 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }
pre  { background: #f1f3f4; padding: 11px; border-radius: 6px; font-size: 12px; overflow-x: auto; line-height: 1.8; margin: 8px 0; }
.chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
.chip     { background: #f1f3f4; padding: 3px 11px; border-radius: 12px; font-size: 12px; }
.chip.red { background: #fce8e6; color: #c5221f; }
.footer   { text-align: center; padding: 22px; color: #bbb; font-size: 12px; }

@media (max-width: 580px) { .input-row { flex-direction: column; } }
</style>
</head>
<body>

<div class="header">
    <h1>ğŸªª Student ID Card Generator</h1>
    <p>Swiss Educational College â€” generate student list + photos automatically</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-panel" id="settingsPanel">
    <button class="settings-toggle" onclick="toggleSettings()">
        <span>âš™ï¸ Settings <span class="s-badge warn" id="sBadge">âš  Setup required â€” click to open</span></span>
        <span class="s-arrow" id="sArrow">â–²</span>
    </button>
    <div class="settings-body" id="settingsBody">
        <div class="callout blue">
            <strong>One-time setup.</strong> Enter both URLs and click Save â€” they are remembered in your browser for future visits.
        </div>

        <label class="field-label" for="inWebApp">
            ğŸ”— Apps Script Web App URL
            <small>â€” backend that reads your sheets and copies photos</small>
        </label>
        <input class="url-input" type="url" id="inWebApp"
               placeholder="https://script.google.com/macros/s/AKfycbâ€¦/exec"
               oninput="onSettingsChange()" />

        <label class="field-label" for="inSheet1">
            ğŸ“‹ Photo Index Sheet URL (Sheet1)
            <small>â€” Col A = Name, Col B = Email, Col C = Drive photo link</small>
        </label>
        <input class="url-input" type="url" id="inSheet1"
               placeholder="https://docs.google.com/spreadsheets/d/â€¦"
               oninput="onSettingsChange()" />

        <div style="margin-top:14px; display:flex; align-items:center; gap:12px;">
            <button class="btn btn-yellow" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
            <span id="savedOk" style="color:#137333; font-size:13px; display:none;">âœ“ Saved!</span>
        </div>

        <div class="acc" style="margin-top:16px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ“‹ How to create the Apps Script and get the Web App URL <span>â–¼</span>
            </button>
            <div class="acc-body">
                <ol>
                    <li>Open any Google Spreadsheet â†’ <strong>Extensions â†’ Apps Script</strong></li>
                    <li>Delete any placeholder code â†’ paste the full contents of <code>StudentIDCards.gs</code> â†’ Save (<kbd>Ctrl+S</kbd>)</li>
                    <li>Click <strong>Deploy â†’ New deployment</strong></li>
                    <li>Click âš™ï¸ gear â†’ <strong>Web app</strong></li>
                    <li>Execute as: <strong>Me</strong> | Who has access: <strong>Anyone</strong></li>
                    <li>Click <strong>Deploy</strong> â†’ grant permissions â†’ copy the Web app URL</li>
                    <li>Paste here â†’ click <strong>ğŸ’¾ Save Settings</strong></li>
                </ol>
                <div class="callout" style="margin-top:10px;">
                    âš ï¸ After any script change: Deploy â†’ Manage deployments â†’ Edit â†’ <em>New version</em> â†’ Deploy.
                </div>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                ğŸ“· Where is the Photo Index Sheet (Sheet1)? <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p>Sheet1 is in the <strong>Metabase_Foto</strong> Google Drive folder. It maps each student's email to their photo file.</p>
                <table class="htbl">
                    <tr><td>Col A</td><td>Student name â€” ignored</td></tr>
                    <tr><td>Col B</td><td>School email e.g. <code>antony.aghilesh@student.swissedcol.ch</code></td></tr>
                    <tr><td>Col C</td><td>Google Drive photo URL â€” thumbnail format fine: <code>https://drive.google.com/thumbnail?id=â€¦&sz=w200</code></td></tr>
                </table>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                âŒ Settings forgotten / not saving <span>â–¼</span>
            </button>
            <div class="acc-body">
                <ul>
                    <li>Click <strong>ğŸ’¾ Save Settings</strong> â€” just typing is not enough</li>
                    <li>Settings persist in browser localStorage on the same device/browser</li>
                    <li>Private/incognito windows don't persist â€” use a regular window</li>
                    <li>Clearing browser data removes saved settings</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 1 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step active" id="step1">
    <div class="step-hdr">
        <div class="step-num"><span class="num">1</span></div>
        <div><span class="step-title">Load Class List</span> <span class="step-sub">(Sheet2)</span></div>
    </div>
    <p style="font-size:13px;color:#555;margin-bottom:10px;">
        Paste the master student list URL. Columns are found by header name automatically.<br>
        <strong>Required headers:</strong> <code>Class</code> Â· <code>First Name Last Name</code> Â· <code>School Email</code> Â· <code>Birthday</code>
    </p>
    <div class="input-row">
        <input type="url" id="inSheet2"
               placeholder="https://docs.google.com/spreadsheets/d/â€¦"
               onkeydown="if(event.key==='Enter') loadClasses()" />
        <button class="btn btn-blue" id="btnLoad" onclick="loadClasses()">Load Classes â†’</button>
    </div>
    <div class="sbar" id="st1"></div>

    <div class="acc" style="margin-top:14px;">
        <button class="acc-btn" onclick="toggleAcc(this)">
            â“ Troubleshooting â€” "Load Classes" not working <span>â–¼</span>
        </button>
        <div class="acc-body">
            <table class="htbl">
                <tr><td>Button does nothing</td><td>The Apps Script URL must be saved first. Open <strong>âš™ï¸ Settings</strong>, paste the Web App URL, click <strong>ğŸ’¾ Save Settings</strong>.</td></tr>
                <tr><td>âŒ Network / fetch error</td><td>Apps Script must be deployed as Web App with <em>Who has access: Anyone</em>. Use the latest <code>StudentIDCards.gs</code> (v6, uses <code>doGet</code>). Re-deploy as a new version after any script change.</td></tr>
                <tr><td>âŒ "Cannot open Sheet2"</td><td>The Apps Script owner must have access to Sheet2. Open Sheet2 â†’ Share â†’ add the owner as Viewer.</td></tr>
                <tr><td>âŒ "Class column not found"</td><td>Row 1 of Sheet2 must have a header cell containing exactly <code>Class</code> (case-insensitive).</td></tr>
                <tr><td>âš ï¸ 0 students / very few rows</td><td>Only rows whose <code>Class</code> column matches the strict <code>YY-TX-Class-*</code> format are counted. All other rows (row numbers, status notes, etc.) are automatically ignored.</td></tr>
            </table>
        </div>
    </div>

    <div class="acc">
        <button class="acc-btn" onclick="toggleAcc(this)">
            ğŸ“‹ Required Sheet2 structure <span>â–¼</span>
        </button>
        <div class="acc-body">
            <table class="htbl">
                <tr><td><code>Class</code></td><td>Must match strict format <code>YY-TX-Class-Level</code> â€” e.g. <code>26-T1-Class-BBA</code>, <code>25-T4-Class-MBA</code>. Rows that don't match (row numbers, status notes, etc.) are silently skipped.</td></tr>
                <tr><td><code>First Name Last Name</code></td><td>Combined name. Nickname patterns removed: <code>-Ann- Thi Dung Phung</code> â†’ <code>Thi Dung Phung</code></td></tr>
                <tr><td><code>School Email</code></td><td>Unique identifier. Must contain <code>@</code>.</td></tr>
                <tr><td><code>Birthday</code></td><td>Any date format accepted. Output always <code>DD/MM/YYYY</code>.</td></tr>
            </table>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step locked" id="step2">
    <div class="step-hdr">
        <div class="step-num"><span class="num">2</span></div>
        <div><span class="step-title">Set Validity Periods</span></div>
    </div>
    <div id="step2locked" class="locked-msg">ğŸ”’ Complete Step 1 first</div>
    <div id="step2content" style="display:none;">
        <p style="font-size:13px;color:#555;margin-bottom:10px;">
            Only valid class groups (<code>YY-TX-Class-*</code>) are shown below â€” all other Sheet2 rows are ignored automatically.
            Set a validity period for each group in <code>MM/YYYY-MM/YYYY</code> format. Leave blank to skip that group.
        </p>
        <table class="vtable">
            <thead><tr>
                <th>Class Prefix</th><th>Students</th><th>Validity Period</th><th></th>
            </tr></thead>
            <tbody id="classBody"></tbody>
        </table>
        <div class="sbar" id="st2"></div>
        <div class="chips" id="classChips"></div>

        <div class="acc" style="margin-top:12px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                â“ Validity period format and defaults <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p>The validity period appears on the ID card. It is based on the student's intake term:</p>
                <table class="htbl" style="margin:8px 0;">
                    <tr><td><code>25-T3-Class-â€¦</code></td><td><code>07/2025-06/2026</code></td></tr>
                    <tr><td><code>25-T4-Class-â€¦</code></td><td><code>10/2025-09/2026</code></td></tr>
                    <tr><td><code>26-T1-Class-â€¦</code></td><td><code>01/2026-12/2026</code></td></tr>
                    <tr><td><code>26-T2-Class-â€¦</code></td><td><code>04/2026-03/2027</code></td></tr>
                </table>
                <p>Values are pre-filled automatically. To add new terms permanently, edit <code>DEFAULT_VALIDITY</code> in <code>index.html</code>.</p>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STEP 3 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="step locked" id="step3">
    <div class="step-hdr">
        <div class="step-num"><span class="num">3</span></div>
        <div><span class="step-title">Generate &amp; Download</span></div>
    </div>
    <div id="step3locked" class="locked-msg">ğŸ”’ Complete Steps 1 &amp; 2 first</div>
    <div id="step3content" style="display:none;">
        <p style="font-size:13px;color:#555;margin-bottom:6px;">
            The Apps Script will copy &amp; rename all photos, create the student list, and organise everything
            into a new folder in your Google Drive:
            <strong>My Drive â†’ Metabase_Foto â†’ IDMakerTool â†’ ID_Files_[date]</strong>
        </p>
        <p style="font-size:13px;color:#c5221f;margin-bottom:16px;">
            â± Takes <strong>1â€“3 minutes</strong> for ~90 students. Do not close this tab.
        </p>
        <div style="text-align:center;margin-bottom:14px;">
            <button class="btn btn-green btn-lg" id="btnGen" onclick="generate()">âš¡ Generate Now</button>
        </div>
        <div id="progWrap" style="display:none;">
            <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
            <div class="prog-lbl" id="progLbl">Startingâ€¦</div>
        </div>
        <div class="sbar" id="st3"></div>
        <div id="result"></div>

        <div class="acc" style="margin-top:16px;">
            <button class="acc-btn" onclick="toggleAcc(this)">
                â“ Generate failed â€” error messages explained <span>â–¼</span>
            </button>
            <div class="acc-body">
                <table class="htbl">
                    <tr><td>âŒ "Failed to fetch"</td><td>Not responding to GET requests. Re-deploy the Apps Script as a <strong>New version</strong> using the latest <code>StudentIDCards.gs</code> (v6 with <code>doGet</code>).</td></tr>
                    <tr><td>âŒ "0 students matched"</td><td>No class prefixes in Step 2 have a validity period set. Fill in at least one row.</td></tr>
                    <tr><td>âš ï¸ Many missing photos</td><td>Those students are in Sheet2 but not Sheet1. Add their email + Drive photo URL to Sheet1 then re-run.</td></tr>
                    <tr><td>âŒ "Cannot access file"</td><td>Photo Drive file not shared with Apps Script owner. Owner needs Viewer access to the file or its folder.</td></tr>
                    <tr><td>â± Times out (~6 min)</td><td>Blank half the validity periods to skip half the students, run, then restore and run again. Already-copied photos are skipped.</td></tr>
                </table>
            </div>
        </div>

        <div class="acc">
            <button class="acc-btn" onclick="toggleAcc(this)">
                â„¹ï¸ How the whole system works <span>â–¼</span>
            </button>
            <div class="acc-body">
                <p>When you click Generate, the Apps Script:</p>
                <ol>
                    <li>Reads Sheet1 â†’ builds email-to-photo lookup</li>
                    <li>Reads Sheet2 â†’ filters to valid class rows with a validity period</li>
                    <li>Cleans names, formats birthdays as <code>DD/MM/YYYY</code></li>
                    <li>Creates <strong>My Drive â†’ Metabase_Foto â†’ IDMakerTool â†’ ID_Files_[datetime]</strong></li>
                    <li>Inside: creates a <code>Photos/</code> subfolder â†’ copies and renames each photo to <code>email.jpg</code></li>
                    <li>Inside: creates a new <code>ID_Cards_Output</code> Google Sheet with 6 columns</li>
                    <li>Photo column uses <code>=HYPERLINK("Photos/email.jpg", â€¦)</code> â€” a relative path that works offline</li>
                </ol>
                <p style="margin-top:8px;"><strong>Name cleaning:</strong></p>
                <table class="htbl">
                    <tr><td><code>-Ann- Thi Dung Phung</code></td><td>â†’ <code>Thi Dung Phung</code></td></tr>
                    <tr><td><code>Phan -Annabelle- Thi Bich Ngan</code></td><td>â†’ <code>Phan Thi Bich Ngan</code></td></tr>
                    <tr><td><code>- Phuong Anh Pham</code></td><td>â†’ <code>Phuong Anh Pham</code></td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OVERVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="acc" style="margin-bottom:20px; border-radius:10px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.07);">
    <button class="acc-btn" onclick="toggleAcc(this)" style="font-size:14px;padding:14px 18px;">
        â„¹ï¸ Full system overview &amp; data requirements <span>â–¼</span>
    </button>
    <div class="acc-body" style="background:white;">
        <p><strong>Three components:</strong></p>
        <table class="htbl" style="margin-bottom:14px;">
            <tr><td>ğŸ“‹ Sheet1 (Photo Index)</td><td>Maps email â†’ Drive photo. Maintained in Metabase_Foto folder. Col B = email, Col C = thumbnail URL.</td></tr>
            <tr><td>ğŸ“Š Sheet2 (Class List)</td><td>Master list of students. One row per student. Only rows with valid <code>YY-TX-Class-*</code> class names are processed.</td></tr>
            <tr><td>âš™ï¸ Apps Script</td><td>Google-hosted backend. Reads both sheets, copies photos, writes output, creates organised Drive folder. No local installation needed.</td></tr>
        </table>
        <p><strong>Output folder structure (created automatically in Drive):</strong></p>
        <pre>My Drive/
  â””â”€â”€ Metabase_Foto/
        â””â”€â”€ IDMakerTool/
              â””â”€â”€ ID_Files_20260224_1430/   â† new folder each run
                    â”œâ”€â”€ ID_Cards_Output     â† Google Sheet â†’ download as .xlsx
                    â””â”€â”€ Photos/             â† already correctly named
                          â”œâ”€â”€ antony.aghilesh@student.swissedcol.ch.jpg
                          â””â”€â”€ â€¦</pre>
        <p style="margin-top:10px;"><strong>Valid class format:</strong> <code>YY-TX-Class-Level</code> â€” two digits, dash, T1â€“T4, dash, Class-, level name. Anything else (row numbers, status notes, internship dates) is silently ignored and never appears in Step 2.</p>
    </div>
</div>

<div class="footer">Swiss Educational College Â· Student ID Card Generator v6</div>

<script>
var DEFAULT_VALIDITY = {
    '25-T3-': '07/2025-06/2026',
    '25-T4-': '10/2025-09/2026',
    '26-T1-': '01/2026-12/2026',
    '26-T2-': '04/2026-03/2027',
    '26-T3-': '07/2026-06/2027',
    '26-T4-': '10/2026-09/2027'
};

var WEB_APP_URL = '';
var SHEET1_URL  = '';

// Valid class prefix: exactly 2 digits, dash, T1-4, dash, Class-
var VALID_CLASS_RE = /^\d{2}-T[1-4]-Class-/;

window.onload = function() {
    WEB_APP_URL = localStorage.getItem('idcard_webapp') || '';
    SHEET1_URL  = localStorage.getItem('idcard_sheet1') || '';
    document.getElementById('inWebApp').value = WEB_APP_URL;
    document.getElementById('inSheet1').value = SHEET1_URL;
    if (WEB_APP_URL) document.getElementById('inWebApp').classList.add('set');
    if (SHEET1_URL)  document.getElementById('inSheet1').classList.add('set');
    updateBadge();
    if (!WEB_APP_URL || !SHEET1_URL) openSettings();
    else closeSettings();
};

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSettings() {
    var body = document.getElementById('settingsBody');
    if (body.classList.contains('hidden')) openSettings(); else closeSettings();
}
function openSettings() {
    document.getElementById('settingsBody').classList.remove('hidden');
    document.getElementById('sArrow').textContent = 'â–²';
}
function closeSettings() {
    document.getElementById('settingsBody').classList.add('hidden');
    document.getElementById('sArrow').textContent = 'â–¼';
}
function saveSettings() {
    WEB_APP_URL = document.getElementById('inWebApp').value.trim();
    SHEET1_URL  = document.getElementById('inSheet1').value.trim();
    localStorage.setItem('idcard_webapp', WEB_APP_URL);
    localStorage.setItem('idcard_sheet1', SHEET1_URL);
    document.getElementById('inWebApp').classList.toggle('set', !!WEB_APP_URL);
    document.getElementById('inSheet1').classList.toggle('set', !!SHEET1_URL);
    updateBadge();
    var ok = document.getElementById('savedOk');
    ok.style.display = 'inline';
    setTimeout(function(){ ok.style.display = 'none'; }, 2500);
}
function onSettingsChange() { document.getElementById('savedOk').style.display = 'none'; }
function updateBadge() {
    var done = WEB_APP_URL && SHEET1_URL;
    var b = document.getElementById('sBadge');
    b.textContent = done ? 'âœ“ Configured' : 'âš  Setup required â€” click to open';
    b.className   = 's-badge ' + (done ? 'good' : 'warn');
    document.getElementById('settingsPanel').className = 'settings-panel' + (done ? ' ok' : '');
}

// â”€â”€ Accordion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAcc(btn) {
    var body = btn.nextElementSibling;
    var open = body.classList.toggle('open');
    var arr  = btn.querySelector('span:last-child');
    if (arr) arr.textContent = open ? 'â–²' : 'â–¼';
}

// â”€â”€ Step 1: Load classes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadClasses() {
    var s2 = document.getElementById('inSheet2').value.trim();
    var wa = document.getElementById('inWebApp').value.trim() || WEB_APP_URL;

    if (!wa) {
        showBar('st1', 'error', 'âŒ Apps Script URL not saved. Open âš™ï¸ Settings, paste the URL and click ğŸ’¾ Save Settings.');
        openSettings(); return;
    }
    WEB_APP_URL = wa;

    if (!s2) { showBar('st1', 'error', 'âŒ Please paste your Sheet2 URL.'); return; }
    if (s2.indexOf('docs.google.com/spreadsheets') === -1) {
        showBar('st1', 'error', 'âŒ That doesn\'t look like a Google Sheets URL.'); return;
    }

    showBar('st1', 'info', 'â³ Connecting to Apps Script and reading Sheet2â€¦');
    document.getElementById('btnLoad').disabled = true;

    callScript({ action: 'loadClasses', sheet2Url: s2 })
        .then(function(data) {
            if (!data.success) throw new Error(data.error || 'Unknown error');
            if (data.classes.length === 0) throw new Error('No valid class groups found. Check that Sheet2 has rows with Class column in YY-TX-Class-Level format.');
            buildClassTable(data.classes, data.totalStudents);
            showBar('st1', 'success', 'âœ… Found ' + data.totalStudents + ' students in ' + data.classes.length + ' class group(s).');
            setDone('step1');
            unlock('step2');
            unlock('step3');
            document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(function(e) {
            showBar('st1', 'error', 'âŒ ' + e.message + ' â€” see troubleshooting above.');
            document.getElementById('step1').className = 'step errored';
        })
        .finally(function() { document.getElementById('btnLoad').disabled = false; });
}

function unlock(id) {
    document.getElementById(id).className = 'step active';
    var l = document.getElementById(id + 'locked');
    var c = document.getElementById(id + 'content');
    if (l) l.style.display = 'none';
    if (c) c.style.display = 'block';
}
function setDone(id) { document.getElementById(id).className = 'step done'; }

function buildClassTable(classes, total) {
    var tbody = document.getElementById('classBody');
    tbody.innerHTML = '';
    var inc = 0, skip = 0;

    classes.forEach(function(c) {
        var def = guessValidity(c.prefix);
        if (def) inc += c.count; else skip += c.count;
        var sid = 'v_' + c.prefix.replace(/[^a-z0-9]/gi, '_');
        var tr  = document.createElement('tr');
        tr.innerHTML =
            '<td><span class="cbadge">' + esc(c.prefix) + '</span></td>' +
            '<td style="color:#666;">' + c.count + '</td>' +
            '<td>' +
                '<input class="val-inp ' + (def ? 'ok' : 'skip') + '" id="' + sid + '"' +
                ' data-prefix="' + esc(c.prefix) + '" value="' + esc(def) + '"' +
                ' placeholder="MM/YYYY-MM/YYYY" oninput="onValChange(this)">' +
                (!def ? ' <span style="font-size:11px;color:#ea4335;margin-left:5px;">will be skipped</span>' : '') +
            '</td>' +
            '<td style="font-size:18px;">' + (def ? 'âœ…' : 'âš ï¸') + '</td>';
        tbody.appendChild(tr);
    });

    if (skip > 0) showBar('st2', 'warning', 'âš ï¸ ' + skip + ' student(s) in unrecognised prefixes â€” add a validity period to include them.');
    else          showBar('st2', 'success',  'âœ… All ' + total + ' students have a validity period.');

    document.getElementById('classChips').innerHTML =
        '<div class="chip">ğŸ‘¥ ' + total + ' total</div>' +
        '<div class="chip">âœ… ' + inc + ' included</div>' +
        (skip ? '<div class="chip red">âš ï¸ ' + skip + ' skipped</div>' : '');
}

function onValChange(inp) {
    var v = inp.value.trim();
    inp.classList.toggle('ok', !!v); inp.classList.toggle('skip', !v);
    var icon = inp.closest('tr').cells[3];
    if (icon) icon.textContent = v ? 'âœ…' : 'âš ï¸';
}

function guessValidity(prefix) {
    // Only attempt match if prefix itself passes the strict format
    if (!VALID_CLASS_RE.test(prefix)) return '';
    for (var k in DEFAULT_VALIDITY) {
        if (DEFAULT_VALIDITY.hasOwnProperty(k) && prefix.indexOf(k) === 0) return DEFAULT_VALIDITY[k];
    }
    return '';
}

// â”€â”€ Step 3: Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generate() {
    var s1 = document.getElementById('inSheet1').value.trim() || SHEET1_URL;
    var s2 = document.getElementById('inSheet2').value.trim();

    if (!WEB_APP_URL) { showBar('st3','error','âŒ Apps Script URL not set â€” open âš™ï¸ Settings.'); openSettings(); return; }
    if (!s1)          { showBar('st3','error','âŒ Photo Index URL not set â€” open âš™ï¸ Settings.'); openSettings(); return; }
    if (!s2)          { showBar('st3','error','âŒ Sheet2 URL missing â€” complete Step 1.'); return; }

    var validityMap = {};
    var inputs = document.querySelectorAll('.val-inp');
    for (var i = 0; i < inputs.length; i++) {
        var p = inputs[i].getAttribute('data-prefix'), v = inputs[i].value.trim();
        if (p && v) validityMap[p] = v;
    }
    if (!Object.keys(validityMap).length) {
        showBar('st3','error','âŒ No validity periods set â€” fill in at least one row in Step 2.'); return;
    }

    document.getElementById('btnGen').disabled = true;
    document.getElementById('result').innerHTML = '';
    document.getElementById('progWrap').style.display = 'block';
    setProgress(8, 'Sending requestâ€¦');
    showBar('st3', 'info', 'â³ Processing â€” do not close this tab. Takes 1â€“3 minutes.');

    callScript({ action: 'generate', sheet1Url: s1, sheet2Url: s2, validityMap: validityMap })
        .then(function(res) {
            setProgress(100, 'Complete!');
            if (!res.success) throw new Error(res.error || 'Generation failed');
            showBar('st3', 'success',
                'âœ… ' + res.studentsCount + ' students â€” ' + res.photoOk + ' photos copied, ' +
                (res.photoErrors ? res.photoErrors.length : 0) + ' missing.');
            renderResult(res);
            setDone('step3');
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(function(e) {
            document.getElementById('progWrap').style.display = 'none';
            setProgress(0, '');
            showBar('st3', 'error', 'âŒ ' + e.message);
            document.getElementById('step3').classList.add('errored');
        })
        .finally(function() { document.getElementById('btnGen').disabled = false; });
}

function renderResult(res) {
    var errs    = res.photoErrors || [];
    var hasErrs = errs.length > 0;
    var errBlock = hasErrs
        ? '<div class="err-log"><strong style="font-size:11px;">Missing photos (' + errs.length + ') â€” add to Sheet1 and re-run:</strong><br>' +
          errs.map(function(e){ return '<div>â€¢ ' + esc(e) + '</div>'; }).join('') + '</div>'
        : '';

    document.getElementById('result').innerHTML =
        // Summary box
        '<div class="result-box ' + (hasErrs ? 'warn' : '') + '">' +
            '<h3>' + (hasErrs ? 'âš ï¸ Done â€” some photos missing' : 'âœ… Generation Complete!') + '</h3>' +
            '<div class="result-stats">' +
                '<div class="result-stat">ğŸ‘¥ ' + res.studentsCount + ' students</div>' +
                '<div class="result-stat">ğŸ“¸ ' + res.photoOk + ' photos</div>' +
                (hasErrs ? '<div class="result-stat">âš ï¸ ' + errs.length + ' missing</div>' : '') +
            '</div>' +
            errBlock +
        '</div>' +

        // Drive folder card
        '<div class="folder-card">' +
            '<h4>ğŸ“ Files organised in Google Drive</h4>' +
            '<div class="folder-path">My Drive â†’ Metabase_Foto â†’ IDMakerTool â†’ ' + esc(res.runFolderName) + '</div>' +
            '<div class="folder-tree">' +
                'ğŸ“ <a href="' + esc(res.runFolderUrl) + '" target="_blank"><strong>' + esc(res.runFolderName) + '</strong></a><br>' +
                '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ“Š <a href="' + esc(res.spreadsheetUrl) + '" target="_blank">ID_Cards_Output</a>' +
                '  <span style="color:#888;font-size:11px;font-family:sans-serif;">â† open â†’ File â†’ Download â†’ Excel (.xlsx)</span><br>' +
                '&nbsp;&nbsp;&nbsp;&nbsp;ğŸ“ Photos/  ' +
                '<span style="color:#888;font-size:11px;font-family:sans-serif;">â† ' + res.photoOk + ' photos â€” already named correctly</span>' +
            '</div>' +
            '<h4 style="color:#333;font-size:14px;margin-bottom:10px;">ğŸ“¥ Download steps</h4>' +
            '<ol class="dl-list">' +
                '<li>Click <strong><a href="' + esc(res.runFolderUrl) + '" target="_blank">Open Drive folder â†—</a></strong> to see both files in one place</li>' +
                '<li>Open <strong>ID_Cards_Output</strong> sheet â†’ <strong>File â†’ Download â†’ Microsoft Excel (.xlsx)</strong> â†’ save to a local folder e.g. <code>StudentIDCards/</code></li>' +
                '<li>Back in the Drive folder: right-click the <strong>Photos</strong> folder â†’ <strong>Download</strong> â†’ Google zips it â†’ save and unzip â†’ you get a folder called <code>Photos</code></li>' +
                '<li>Place the <code>Photos</code> folder next to the <code>.xlsx</code> file (same directory)</li>' +
                '<li>Open the Excel â†’ click any cell in <strong>Link_to_Cropped_Photo</strong> â†’ photo opens locally ğŸ‰</li>' +
                '<li>Optional: ZIP the whole folder to share â€” works on any machine</li>' +
            '</ol>' +
            '<div class="callout green" style="margin-top:6px;">âœ… The <code>Photos</code> folder is <strong>already named correctly</strong> â€” no renaming needed this time.</div>' +
        '</div>';
}

// â”€â”€ Network â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function callScript(payload) {
    var base = WEB_APP_URL || document.getElementById('inWebApp').value.trim();
    if (!base) return Promise.reject(new Error('Apps Script URL not set â€” open âš™ï¸ Settings.'));

    var url = base + '?payload=' + encodeURIComponent(JSON.stringify(payload));
    return fetch(url, { method: 'GET', redirect: 'follow' })
        .catch(function(err) {
            throw new Error('Cannot reach Apps Script. Check URL in Settings and that it is deployed as Web App with "Anyone" access. Detail: ' + err.message);
        })
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status + ' â€” re-deploy Apps Script as a new version.');
            return r.text();
        })
        .then(function(text) {
            try { return JSON.parse(text); }
            catch(e) { throw new Error('Apps Script returned non-JSON. Re-deploy using latest StudentIDCards.gs. Preview: ' + text.substring(0, 200)); }
        });
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBar(id, type, msg) {
    var el = document.getElementById(id);
    el.className  = 'sbar show ' + type;
    el.textContent = msg;
}
function setProgress(pct, lbl) {
    document.getElementById('progFill').style.width = pct + '%';
    document.getElementById('progLbl').textContent  = lbl;
}
function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
